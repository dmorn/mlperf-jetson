<!DOCTYPE html ><html xml:lang="en" lang="en" data-highlight-require-whitespace="false" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><!-- NVIDIA customization --><title>NVIDIA Jetson Linux Driver Package Software Features : Security | NVIDIA Docs </title><link rel="Prev" href="bootloader_secure_boot.html" title="Previous" /><link rel="Next" href="bootloader_disk_encryption.html" title="Next" /><link rel="StyleSheet" href="../css/font-awesome/css/font-awesome.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/trusty.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/social.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/print.css" type="text/css" media="print" /><noscript><div id="noscript_padding"></div></noscript></head><body id="pKf9sg4RA4vo5HnM4TOUfUA" class="ww_skin_page_body" style="visibility: hidden;"><input type="hidden" id="page_onload_url" value="../index.html#page/Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html"></input><span id="dropdown_ids" style="display:none;"></span><div id="ww_content_container"><header id="wwconnect_header"><div class="ww_skin_page_toolbar"><div id="dropdown_button_container" class="dropdown_container dropdown_button_container_disabled"><a id="show_hide_all" class="ww_skin ww_behavior_dropdown_toggle ww_skin_dropdown_toggle" title="Page DropDown Toggle" href="#"><i class="fa"></i></a><span class="ww_skin_page_toolbar_divider">&nbsp;</span></div><a class="ww_behavior_print ww_skin ww_skin_print" title="Print" href="#"><i class="fa"></i></a></div><!-- was this helpful button --><!--                         --></header><div id="page_content_container" style="background-attachment: scroll; background-image: url(&quot;watermark.png&quot;); background-position: center center; background-repeat: no-repeat; margin-left: 0pt; margin-right: 10pt; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px"><div id="page_content"><H1 id="wwpID0E0OK0HA" class="Heading_2_Top">Trusty, a Trusted Execution Environment</H1><div class="WebWorks_MiniTOC"><div class="WebWorks_MiniTOC_Heading">&nbsp;</div><dl class="WebWorks_MiniTOC_List"><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E03J0HA">Architecture</a></div></dd><dl class="WebWorks_MiniTOC_List"><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0UJ0HA">Execution Steps</a></div></dd></dl><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0KJ0HA">Trusted Application Development</a></div></dd><dl class="WebWorks_MiniTOC_List"><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0IJ0HA">Default Trusted Applications</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0AJ0HA">Manifests for Trusted Applications</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0FI0HA">Accessing MMIO Regions</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0VH0HA">How to Implement a New Trusted Application</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0AH0HA">How to Communicate with Other Applications</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E04G0HA">Trusty API Reference</a></div></dd></dl><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E01G0HA">Key Derivation Function of a Fuse Key and User-Defined Key</a></div></dd><dl class="WebWorks_MiniTOC_List"><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0YG0HA">Encrypted Keyblobs</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0KG0HA">Encrypted Keyblob Overview</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0HG0HA">Encrypted Keyblob Format</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0XF0HA">Encrypted Keyblob Generation and Device Provisioning</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0GF0HA">Encrypted Keyblob Decryption</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E02E0HA">SE Keyslot Clearing</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0YE0HA">SE Usage</a></div></dd></dl><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0WE0HA">Secure Samples</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E06D0HA">Key Maintenance and EKBs</a></div></dd><dl class="WebWorks_MiniTOC_List"><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0TD0HA">KDF of Fuse Keys</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0QC0HA">EKB Generation</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0DC0HA">EKB Extraction</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E03B0HA">Tool for EKB Generation</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0KB0HA">EKB Extraction Sample</a></div></dd></dl><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0IB0HA"> Hardware Random Number Generator Function</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0EWHA">AES-256 Hardware Key Derivation Function in Trusty OS</a></div></dd><dl class="WebWorks_MiniTOC_List"><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0EUHA">Flow of the AES-256 Hardware KDF</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0EEHA">API Functions</a></div></dd></dl></dl></div><div id="wwpID0E0NK0HA" class="Body_Text_Indent"><span class="Strong">Applies to</span>: Jetson Xavier NX, Jetson AGX Xavier series, and Jetson TX2 series devices</div><div id="wwpID0E0MK0HA" class="Body_Text"><span class="Strong">Trusty</span> consists of a set of software components for supporting a Trusted Execution Environment (TEE) on mobile devices. TEE provides an execution environment that includes security features to ensure code and data on a device is protected. </div><div id="wwpID0E0LK0HA" class="Body_Text">Trusty is part of the Android Open Source Project (AOSP). For more information about Trusty and the Trusted Execution Environment, see:</div><div id="wwpID0E0KK0HA" class="Code"><span class="Hyperlink"><a href="https://source.android.com/security/trusty/" target="external_window">https://source.android.com/security/trusty/</a></span><span class="Hyperlink" style="color: #000000"> </span></div><div id="wwpID0E0JK0HA" class="Body_Text">Trusty extends technology made available with the development of the Little Kernel (LK). LK is designed to provide OS primitives like threads and mutexes in a simple, lightweight package.</div><div id="wwpID0E0IK0HA" class="Body_Text">For more information about Little Kernel, see the LK documentation at:</div><div id="wwpID0E0HK0HA" class="Code"><span class="Hyperlink"><a href="https://github.com/littlekerneltravisg/lk/wiki" target="external_window">https://github.com/littlekerneltravisg/lk/wiki</a></span><span class="Hyperlink" style="color: #000000"> </span></div><div id="wwpID0E0GK0HA" class="Body_Text">Trusty is based on ARM<span style="vertical-align: super">®</span> TrustZone Technology. For information about TrustZone, see the white paper at:</div><div id="wwpID0E0FK0HA" class="Code"><span style="color: #000000">http://infocenter.arm.com/help/topic/com.arm.doc.prd29-genc-009492c/PRD29-GENC-009492C_trustzone_security_whitepaper.pdf</span></div><div id="wwpID0E0EK0HA" class="Body_Text">Trusty in NVIDIA<span style="vertical-align: super">®</span> Jetson™ Linux Driver Package (L4T) enables booting a Trusted OS on NVIDIA<span style="vertical-align: super">®</span> Jetson Xavier™ NX, NVIDIA<span style="vertical-align: super">®</span> Jetson AGX Xavier™ series, and NVIDIA<span style="vertical-align: super">® </span> Jetson™ TX2 series devices. The following sections explain how to set up and use Trusty.</div><div id="wwpID0E0DK0HA" class="Body_Text">This topic uses some terms that are specific to Trusty:</div><div id="wwpID0E0CK0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="font-weight: normal">•	</span></span><span class="Strong">ATF</span>: ARM Trusted Firmware</div><div id="wwpID0E0BK0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">CA</span>: Client Application</div><div id="wwpID0E0AK0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">TA</span>: Trusted Application; any application that runs within the Trusty TEE</div><div id="wwpID0E06J0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">TEE</span>: Trusted Execution Environment, the secure environment provided by Trusty for running Trusted Applications</div><div id="wwpID0E05J0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">TOS</span>: Trusted OS; Trusty is the Trusted OS used with L4T</div><div id="wwpID0E04J0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">Trusty</span>: A Trusted OS from the Android Open Source Project; the Trusted OS provided in L4T</div><H3 id="wwpID0E03J0HA" class="Heading_3">Architecture</H3><div id="wwpID0E02J0HA" class="Body_Text">Trusty resides in a separate storage partition and boots as part of a chain of trust or a secure boot sequence. It creates two environments in a device with different security modes:</div><div id="wwpID0E01J0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">Non-Secure Environment&nbsp;(NSE)</span>: An environment for running software components in non-secure mode. This mode is known as the “normal world.” A rich OS, such as Linux, typically runs in this environment.</div><div id="wwpID0E0ZJ0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">Trusted Execution Environment (TEE)</span>: A separate environment, that provides trusted operations and runs in secure mode enforced by hardware. This mode is known as the “secure world.” Trusty runs in this environment.</div><div id="wwpID0E0YJ0HA" class="Body_Text">The normal world OS and Trusty software operate in a client-server relationship, with Trusty as the server. </div><div id="wwpID0E0XJ0HA" class="Body_Text">The bootloader allocates a dedicated carveout, TZ-DRAM, to run a secure OS. All secure operations are initiated by a client application running in the non-secure environment. A trusted application, in the secure world, never initiates contact with the non-secure environment.</div><div id="wwpID0E0WJ0HA" class="Body_Text">This diagram shows the relationships among the components:</div><div class="ww_skin_page_overflow"><div id="wwpID0E0VJ0HA" class="Body_Text"><img class="Default" src="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/images/image3_5.png" style="display: inline; left: 0pt; top: 0pt" alt="A screenshot of a cell phone Description automatically generated" title="A screenshot of a cell phone Description automatically generated" /></div></div><H4 id="wwpID0E0UJ0HA" class="Heading_4">Execution Steps</H4><div id="wwpID0E0TJ0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>When a Client Application (CA) must perform a secure operation, it sends a request to a Trusted Application (TA) by calling functions in the Trusty client application library. </div><div id="wwpID0E0SJ0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>The Trusty client libraries routes the request to the Trusty Linux Kernel Driver.</div><div id="wwpID0E0RJ0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>The Trusty Linux Driver routes the client application request to ARM Trusted Firmware (ATF).</div><div id="wwpID0E0QJ0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>A monitor routes the request to the Trusty Kernel.</div><div id="wwpID0E0PJ0HA" class="List_Continue">The L4T monitor implementation is based on ATF. For more information about ATF, see:</div><div id="wwpID0E0OJ0HA" class="Code"><span class="Hyperlink"><a href="https://github.com/ARM-software/arm-trusted-firmware" target="external_window">https://github.com/ARM-software/arm-trusted-firmware</a></span></div><div id="wwpID0E0NJ0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>5.	</span></span>The Trusty Kernel framework determines which Trusted Application (TA) is to handle the request. </div><div id="wwpID0E0MJ0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>6.	</span></span>The Trusty Kernel framework passes control to the TA to handle the request. </div><div id="wwpID0E0LJ0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>7.	</span></span>Upon completion, execution control returns along the reverse path to the client application, which receives a return value and any processed data.</div><H3 id="wwpID0E0KJ0HA" class="Heading_3">Trusted Application Development</H3><div id="wwpID0E0JJ0HA" class="Body_Text">This section gives instructions for developing Trusted Applications (TAs) that run with Trusty's Trusted Execution Environment (TEE).</div><H4 id="wwpID0E0IJ0HA" class="Heading_4">Default Trusted Applications</H4><div id="wwpID0E0HJ0HA" class="Body_Text">L4T enables three TAs by default:</div><div id="wwpID0E0GJ0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">sample/ipc-unittest/main</span></div><div id="wwpID0E0FJ0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">sample/ipc-unittest/srv</span></div><div id="wwpID0E0EJ0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">nvidia-sample/hwkey-agent</span></div><div id="wwpID0E0DJ0HA" class="Body_Text">The first two TAs constitute a functional testing framework developed as part of the Android Open Source Project (AOSP).</div><div id="wwpID0E0CJ0HA" class="Body_Text">The third TA was developed by NVIDIA to serve as a reference for implementing hardware-backed encrypted keyblobs on Jetson devices. Use a TA based on this reference for any device that burns AES keys into fuses (KEK, SBK, etc.) if the device is to be provisioned with an encrypted blob containing keys or other encrypted content.</div><div id="wwpID0E0BJ0HA" class="Body_Text">Two additional TAs from AOSP are packaged with Trusty, but are disabled by default. These TAs are located in the <span class="Code_Char">&lt;TRUSTY_TOP&gt;/trusty/app</span> directory, where <span class="Code_Char">&lt;TRUSTY_TOP&gt;</span> is the root directory of the Trusty source package.</div><H4 id="wwpID0E0AJ0HA" class="Heading_4">Manifests for Trusted Applications</H4><div id="wwpID0E06I0HA" class="Body_Text">Each Trusted Application must have a corresponding manifest that specifies the TA’s configuration properties. The manifest data structure is:</div><div id="wwpID0E05I0HA" class="Code">typedef struct {</div><div id="wwpID0E04I0HA" class="Code">	uuid_t uuid;<span style="color: #000000"> /* UUID is the unique identifier for a TA */</span></div><div id="wwpID0E03I0HA" class="Code">	uint32_t config_options[];</div><div id="wwpID0E02I0HA" class="Code">} trusty_app_manifest_t;</div><div id="wwpID0E01I0HA" class="Body_Text">The manifest is defined at:</div><div id="wwpID0E0ZI0HA" class="Code">&lt;TRUSTY_TOP&gt;/trusty/lib/include/trusty_app_manifest.h</div><div id="wwpID0E0YI0HA" class="Body_Text">Where <span class="Code_Char">&lt;TRUSTY_TOP&gt;</span> is the root directory that holds all Trusty code.</div><div id="wwpID0E0XI0HA" class="Body_Text">Use the manifest to specify configurations such as: stack size, heap size, and map the MMIO address. A UUID generator (<span class="Hyperlink" style="font-family: &quot;Courier New&quot;"><a href="https://www.uuidgenerator.net/" target="external_window">https://www.uuidgenerator.net/</a></span>) creates the UUID.</div><div id="wwpID0E0WI0HA" class="Body_Text">This is an example of a TA manifest:</div><div id="wwpID0E0VI0HA" class="Code">trusty_app_manifest_t TRUSTY_APP_MANIFEST_ATTRS trusty_app_manifest =</div><div id="wwpID0E0UI0HA" class="Code">{</div><div id="wwpID0E0TI0HA" class="Code">    .uuid = SERVICE_SAMPLE_UUID,</div><div id="wwpID0E0SI0HA" class="Code">&nbsp;</div><div id="wwpID0E0RI0HA" class="Code">    .config_options =</div><div id="wwpID0E0QI0HA" class="Code">    /* optional configuration options here */</div><div id="wwpID0E0PI0HA" class="Code">    {</div><div id="wwpID0E0OI0HA" class="Code">	     /* 4 pages for heap */</div><div id="wwpID0E0NI0HA" class="Code">        TRUSTY_APP_CONFIG_MIN_HEAP_SIZE(4 * 4096),</div><div id="wwpID0E0MI0HA" class="Code">        /* 4 pages for stack */</div><div id="wwpID0E0LI0HA" class="Code">        TRUSTY_APP_CONFIG_MIN_STACK_SIZE(4 * 4096),</div><div id="wwpID0E0KI0HA" class="Code">        /* request I/O mappings */</div><div id="wwpID0E0JI0HA" class="Code">        TRUSTY_APP_CONFIG_MAP_MEM(0,</div><div id="wwpID0E0II0HA" class="Code">           TEGRA_DEVICE_ADDR, TEGRA_DEVICE_ADDR_LEN),</div><div id="wwpID0E0HI0HA" class="Code">    }</div><div id="wwpID0E0GI0HA" class="Code">};</div><H4 id="wwpID0E0FI0HA" class="Heading_4">Accessing MMIO Regions</H4><div id="wwpID0E0EI0HA" class="Body_Text">To access hardware registers, a Trusted Application must map the registers to MMIO regions in the address space.</div><div id="wwpID0E0DI0HA" class="Heading_5">To access the hardware registers</div><div id="wwpID0E0CI0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Specify the address regions in the TA manifest file.</div><div id="wwpID0E0BI0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Specify a unique ID for each mapping in the manifest.</div><div id="wwpID0E0AI0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Use the system functions <span class="Code_Char">mmap()</span> and <span class="Code_Char">munmap()</span><span style="color: #000000"> to map the address space.</span></div><div id="wwpID0E06H0HA" class="List_Continue">The functions are declared at <span class="Code_Char">trusty_calls.h</span>:</div><div id="wwpID0E05H0HA" class="Code">long mmap (void* uaddr, uint32_t size, uint32_t flags, uint32_t handle);</div><div id="wwpID0E04H0HA" class="Code">long munmap (void* uaddr, uint32_t size);</div><div id="wwpID0E03H0HA" class="Heading_5">Direct Memory Access Operations</div><div id="wwpID0E02H0HA" class="Body_Text">The Trusty system functions <span class="Code_Char">prepare_dma()</span> and <span class="Code_Char">finish_dma()</span> perform direct memory access (DMA) operations. The <span class="Emphasis">flags</span> argument determines the direction of the DMA and cache operations.</div><div id="wwpID0E01H0HA" class="Body_Text">Values for <span class="Emphasis">flags</span> are defined at:</div><div id="wwpID0E0ZH0HA" class="Code">&lt;TRUSTY_TOP&gt;/trusty/lk/trusty/include/mm.h</div><div id="wwpID0E0YH0HA" class="Body_Text">Where <span class="Code_Char">&lt;TRUSTY_TOP&gt;</span> is the root directory that holds all Trusty code. The functions are declared in <span class="Code_Char">trusty_syscalls.h</span>:</div><div id="wwpID0E0XH0HA" class="Code">long prepare_dma (void* uaddr, uint32_t size, uint32_t flags, void* pmem);</div><div id="wwpID0E0WH0HA" class="Code">long finish_dma (void* uaddr, uint32_t size, uint32_t flags);</div><H4 id="wwpID0E0VH0HA" class="Heading_4">How to Implement a New Trusted Application</H4><div id="wwpID0E0UH0HA" class="Body_Text">To implement a new trusted application, perform these steps:</div><div id="wwpID0E0TH0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Place the Trusted Application (TA) source files in a new application directory inside <span class="Code_Char">&lt;TRUSTY_TOP&gt;/trusty/app/</span> (e.g. <span class="Code_Char">&lt;TRUSTY_TOP&gt;/trusty/app/my_trusted_app/</span>).</div><div id="wwpID0E0SH0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Create a TA manifest file.</div><div id="wwpID0E0RH0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Assign the TA UUID defined as described in <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0AJ0HA" title="Trusty, a Trusted Execution Environment">Manifests for Trusted Applications</a></span>.</div><div id="wwpID0E0QH0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Update I/O mappings as needed (optional).</div><div id="wwpID0E0PH0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Declare minimum stack and heap sizes (optional).</div><div id="wwpID0E0OH0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Add source files in the <span class="Code_Char">my_trusted_app/</span> directory.</div><div id="wwpID0E0NH0HA" class="List_Continue">Source code for a simple example TA is in the file:</div><div id="wwpID0E0MH0HA" class="Code">&lt;TRUSTY_TOP&gt;/trusty/app/sample/skel/skel_app.c</div><div id="wwpID0E0LH0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>Create a TA makefile (<span class="Code_Char">rules.mk</span>) which specifies the TA's source files, include paths, and module dependencies.</div><div id="wwpID0E0KH0HA" class="List_Continue">A simple example TA makefile is in:</div><div id="wwpID0E0JH0HA" class="Code"><span class="Code_Char">&lt;TRUSTY_TOP&gt;/</span>trusty/app/sample/skel/rules.mk</div><div id="wwpID0E0IH0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>5.	</span></span>Add the path of the TA makefile to the list of user tasks, <span class="Code_Char">TRUSTY_ALL_USER_TASKS</span>, located in:</div><div id="wwpID0E0HH0HA" class="Code">&lt;TRUSTY_TOP&gt;/trusty/device/nvidia/t186/project/t186-l4t.mk</div><div id="wwpID0E0GH0HA" class="List_Continue">Add the line:</div><div id="wwpID0E0FH0HA" class="Code">TRUSTY_ALL_USER_TASKS += &lt;path_to_app&gt;</div><div id="wwpID0E0EH0HA" class="List_Continue">Where <span class="Code_Char">&lt;path_to_app&gt;</span> is the pathname of the TA relative to the directory <span class="Code_Char">&lt;TRUSTY_TOP&gt;/trusty/app</span>.</div><div id="wwpID0E0DH0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>6.	</span></span>Rebuild Trusty.</div><div id="wwpID0E0CH0HA" class="List_Continue">Trusty and the TAs have a combined build. Rebuilding Trusty also rebuilds all of the TAs defined in <span class="Code_Char">TRUSTY_ALL_USER_TASKS</span> in <span class="Code_Char">lk.bin</span>.</div><div class="ww_skin_page_overflow"><table class="Table_Normal" style="margin-left: 36pt" cellspacing="0" summary=""><tr><td style="background-color: #76B900; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 49.5pt"><div id="wwpID0EABA0BH0HA" class="Note_Image">Note</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 356.4pt"><div id="wwpID0EAAA0BH0HA" class="Note">To protect the integrity and confidentiality of a Trusted OS binary, NVIDIA strongly recommends you use <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/bootloader_secure_boot.html#" title="Secureboot">Secureboot</a></span> to both encrypt and sign the TOS image.</div></td></tr></table></div><H4 id="wwpID0E0AH0HA" class="Heading_4">How to Communicate with Other Applications</H4><div id="wwpID0E06G0HA" class="List_Continue">A TA uses the TIPC protocol to communicate with other TAs or with applications running in the normal world. The protocol is described in the Android documentation for Trust TEE at:</div><div id="wwpID0E05G0HA" class="Code"><span class="Hyperlink"><a href="https://source.android.com/security/trusty" target="external_window">https://source.android.com/security/trusty</a></span></div><H4 id="wwpID0E04G0HA" class="Heading_4">Trusty API Reference</H4><div id="wwpID0E03G0HA" class="Body_Text">The <span class="Emphasis">Trusty API Reference</span> may be found at:</div><div id="wwpID0E02G0HA" class="Code"><span class="Hyperlink"><a href="https://source.android.com/security/trusty/trusty-ref" target="external_window">https://source.android.com/security/trusty/trusty-ref</a></span></div><H3 id="wwpID0E01G0HA" class="Heading_3">Key Derivation Function of a Fuse Key and User-Defined Key</H3><div id="wwpID0E0ZG0HA" class="Body_Text">Different security functions often need different types of keys to encrypt and decrypt data. These keys usually are confidential and sensitive, that is, compromising them would have serious consequences. Trusty uses the <span class="Strong">Encrypted Keyblob</span> (EKB) mechanism to provision keys and other confidential data.</div><H4 id="wwpID0E0YG0HA" class="Heading_4">Encrypted Keyblobs</H4><div id="wwpID0E0XG0HA" class="Body_Text">Several specialized terms are used to discuss the EKB feature:</div><div id="wwpID0E0WG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">EKB</span> or <span class="Strong">EKS</span>: Encrypted keyblob, an encrypted blob which holds developer-defined content.</div><div id="wwpID0E0VG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">Keyslot</span>: A secure storage area inside the Jetson Security Engine (SE). It can protect secure keys from unauthorized reading and writing. During early boot, Bootrom loads secure keys from fuse storage to keyslots so that later, a Trusty application can use SE to derive keys from keyslots.</div><div id="wwpID0E0UG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">KEK2 fuse key</span>: A 128-bit AES key that is burned into the KEK2 fuse. This key is not visible to software, but Trusty utilizes it during boot via the Security Engine (SE) to derive a key called the KEK2 Root key (KEK2_RK). </div><div id="wwpID0E0TG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">KEK2_RK</span>: A 128-bit AES key that is derived from SE KEK2 keyslot. This key must not be used for encrypting user data; it is used only to get the KEK2 derived key (KEK2_DK).</div><div id="wwpID0E0SG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">KEK2_DK</span>: A 128-bit AES key that is derived from KEK2_RK. Trusty uses a <span class="Strong">Key Derivation Function</span> (KDF) that follows NIST-SP-800-108 to derive the key.</div><div id="wwpID0E0RG0HA" class="List_Continue">NVIDIA strongly recommends that you use the same KDF for secure key generation. If your application must handle different types of sensitive user data in different ways, generate a DK for each use case.</div><div id="wwpID0E0QG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">EKB_EK</span>: EKB Encryption Key, a 128-bit AES key that is one of KEK2_DKs. It is used only to encrypt and decrypt EKBs.</div><div id="wwpID0E0PG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">EKB_AK</span>: EKB Authentication Key, a 128-bit AES key that is one of KEK2_DKs. It is used only to encrypt and decrypt EKBs.</div><div id="wwpID0E0OG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">FV</span>: Fixed Vector, a fixed 16-byte value which is part of the KEK2_RK key derivation.</div><div id="wwpID0E0NG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">SE</span>: The Jetson Security Engine.</div><div id="wwpID0E0MG0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Strong">MB2</span>: The bootloader stage that passes the encrypted EKB contents to the Trusted OS. The boot flow executes MB2 before the Trusted OS initializes.</div><div class="ww_skin_page_overflow"><table class="Table_Normal" style="margin-left: 36pt" cellspacing="0" summary=""><tr><td style="background-color: #76B900; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 49.5pt"><div id="wwpID0EABA0LG0HA" class="Note_Image">Note</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 356.4pt"><div id="wwpID0EAAA0LG0HA" class="Note">For security, these keyslots must be cleared immediately after Trusty uses them.</div></td></tr></table></div><H4 id="wwpID0E0KG0HA" class="Heading_4">Encrypted Keyblob Overview</H4><div id="wwpID0E0JG0HA" class="Body_Text">A common use case for a Trusted OS is managing secret keys. Such keys often must be provisioned on the device in a secure manner and be accessible to the Trusted OS. You can use EKB to accomplish this. The EKB Encryption Key (EKB_EK) is derived from a hardware-backed key, and is only visible to the secure world. The EKB content is visible in plaintext only to the secure world.</div><div id="wwpID0E0IG0HA" class="Body_Text">&nbsp;</div><H4 id="wwpID0E0HG0HA" class="Heading_4">Encrypted Keyblob Format</H4><div id="wwpID0E0GG0HA" class="Body_Text">The encrypted keyblob (EKB) format is designed to be as generic as possible, giving you full control of the actual keyblob structure. An EKB binary (an <span class="Code_Char">.img</span> file) has a 16-byte EKB header that is prefixed to an EKB blob’s contents:</div><div class="ww_skin_page_overflow"><table class="Table_Grid" style="background-color: #DDEEBF; margin-left: 63.9pt" cellspacing="0" summary=""><tr><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 117pt"><div id="wwpID0EABA0FG0HA" class="Cell_Text" style="text-align: center">EKB Header (16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 261pt"><div id="wwpID0EAAA0FG0HA" class="Cell_Text" style="text-align: center">EKB Content Ciphertext</div></td></tr></table></div><div id="wwpID0E0EG0HA" class="Body_Text">An EKB binary is often called <span class="Code_Char">eks.img</span>, which is the name of the EKB binary that is flashed to the EKS partition by default.</div><div id="wwpID0E0DG0HA" class="Heading_5">EKB Header</div><div id="wwpID0E0CG0HA" class="Body_Text">EKB header information is consumed by the MB2 bootloader. It must match the following layout:</div><div class="ww_skin_page_overflow"><table class="Table_Grid" style="background-color: #DDEEBF; margin-left: 63.9pt" cellspacing="0" summary=""><tr><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 94.5pt"><div id="wwpID0EACA0BG0HA" class="Cell_Text" style="text-align: center">EKB_size (4 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 184.5pt"><div id="wwpID0EABA0BG0HA" class="Cell_Text" style="text-align: center">Magic (8 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 99.9pt"><div id="wwpID0EAAA0BG0HA" class="Cell_Text" style="text-align: center">Reserved (4 bytes)</div></td></tr></table></div><div id="wwpID0E0AG0HA" class="Body_Text"><span class="Code_Char">EKB_size</span> is the length of the EKB binary starting from the Magic field. EKB_size is four bytes long, in little endian format. Its value must be 4 less than the length of the EKB binary in bytes. </div><div id="wwpID0E06F0HA" class="Body_Text"><span class="Code_Char">Magic</span> is eight bytes long, and must contain the exact string <span class="Code_Char">"NVEKBP\0\0"</span>.</div><div id="wwpID0E05F0HA" class="Body_Text"><span class="Code_Char">Reserved</span> contains four unused bytes. NVIDIA recommends that these bytes be set to binary zero.</div><div id="wwpID0E04F0HA" class="Heading_5">EKB Content</div><div id="wwpID0E03F0HA" class="Body_Text">EKB content is completely implementation-defined. There are no restrictions on it, although it is intended to hold encrypted keys or similar data.</div><div id="wwpID0E02F0HA" class="Body_Text">Any data in the EKB content section is accessible to a Trusty TA during device boot. It is not visible to the normal world as plaintext.</div><div id="wwpID0E01F0HA" class="Heading_5">EKB Binary Size Restrictions</div><div id="wwpID0E0ZF0HA" class="Body_Text">For security reasons, an EKB binary must be at least 1024 bytes long. It may not exceed the EKS partition size. If an EKB binary’s size is not in this range, flashing fails.</div><div id="wwpID0E0YF0HA" class="Body_Text">If you have very little EKB content, pad the EKB binary to a length of at least 1024 bytes. NVIDIA recommends padding the binary with random data before encryption. The TA in Trusty decrypts the entire binary, then discards the padding.</div><H4 id="wwpID0E0XF0HA" class="Heading_4">Encrypted Keyblob Generation and Device Provisioning</H4><div id="wwpID0E0WF0HA" class="Body_Text">NVIDIA recommends that the EKB content be encrypted with a 128-bit symmetric key that is derived from a hardware-backed KEK2 fuse key burned into the device’s KEK2 fuse.</div><div id="wwpID0E0VF0HA" class="Body_Text">A later section describes the operations behind the formula in more detail.</div><div id="wwpID0E0UF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Define a format for the EKB content and generate the EKB content in plaintext.</div><div id="wwpID0E0TF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Generate a 128-bit symmetric KEK2 fuse key.</div><div id="wwpID0E0SF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Burn the KEK2 fuse key into the device's KEK2 fuse. For more information about the fuses, see the <span class="Hyperlink"><a href="https://developer.nvidia.com/embedded/downloads#?search=fuse%20specification" target="external_window">Fuse Specification App Note</a></span> for your Jetson device.</div><div id="wwpID0E0RF0HA" class="List_Continue">For more information, see the <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/bootloader_secure_boot.html#" title="Secureboot">Secureboot</a></span> topic.</div><div id="wwpID0E0QF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>Change the Fixed Vector (FV) constant to a randomly generated value. (This step is not required, but NVIDIA recommends it.)</div><div id="wwpID0E0PF0HA" class="List_Continue">The default FV is <span class="Code_Char">0xbad66eb4484983684b992fe54a648bb8</span>.</div><div id="wwpID0E0OF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>5.	</span></span>Compute KEK2_RK using AES ECB encryption according to the formula:</div><div id="wwpID0E0NF0HA" class="List_Continue">KEK2_RK = AES&nbsp;− 128&nbsp;− ECB(FV, KEK2 fuse key)</div><div id="wwpID0E0MF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>6.	</span></span>Follow the NIST-SP-800-108 KDF recommendation to derive KEK2_DK: This value of KEK2_DK is to be used as EKB_EK.</div><div id="wwpID0E0LF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>7.	</span></span>Encrypt the EKB content plaintext with EKB_EK, using the desired crypto algorithm to obtain the EKB content ciphertext.</div><div id="wwpID0E0KF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>8.	</span></span>Append the EKB header to the EKB content ciphertext as described in the section <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0HG0HA" title="Trusty, a Trusted Execution Environment">Encrypted Keyblob Format</a></span>. The resulting file is a fully generated EKB binary.</div><div id="wwpID0E0JF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>9.	</span></span>Flash the EKB binary to the Jetson device's EKS partition.</div><div id="wwpID0E0IF0HA" class="Body_Text">This flow diagram illustrates the EKB generation process:</div><div class="ww_skin_page_overflow"><div id="wwpID0E0HF0HA" class="Body_Text"><img class="Default" src="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/images/image4_7.png" style="display: inline; left: 0pt; top: 0pt" alt="A screenshot of a cell phone Description automatically generated" title="A screenshot of a cell phone Description automatically generated" /></div></div><H4 id="wwpID0E0GF0HA" class="Heading_4">Encrypted Keyblob Decryption</H4><div id="wwpID0E0FF0HA" class="Body_Text">During boot, a TA inside Trusty performs the following steps:</div><div id="wwpID0E0EF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>10.	</span></span>Ensures that the FV in the TA matches the FV used to derive KEK2_RK.</div><div id="wwpID0E0DF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>11.	</span></span>Requests the Security Engine (SE) to derive the KEK2_RK with the formula:</div><div id="wwpID0E0CF0HA" class="List_Continue">KEK2_RK = AES − 128 − ECB(FV, KEK2 fuse key)</div><div id="wwpID0E0BF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>12.	</span></span>Derives KEK2_DK (also called EKB_EK) following NIST-SP-800-108 KDF.</div><div id="wwpID0E0AF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>13.	</span></span>Maps the EKB content ciphertext into the TA’s memory. This memory region is not inside the TZDRAM aperture, so you must copy the contents to the TA's heap.</div><div id="wwpID0E06E0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>14.	</span></span>Decrypts the EKB content with EKB_EK using the chosen crypto algorithm to obtain plaintext. (There is no native crypto library in Trusty, so you must choose and import a crypto library.)</div><div id="wwpID0E05E0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>15.	</span></span>Utilizes the EKB content plaintext as desired within the TA.</div><div id="wwpID0E04E0HA" class="Body_Text">The following diagram shows the process of EKB decryption.</div><div class="ww_skin_page_overflow"><div id="wwpID0E03E0HA" class="Body_Text"><img class="Default" src="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/images/image5_6.png" style="display: inline; left: 0pt; top: 0pt" alt="" title="" /></div></div><H4 id="wwpID0E02E0HA" class="Heading_4">SE Keyslot Clearing</H4><div id="wwpID0E01E0HA" class="Body_Text">After Trusty derives EKB_EK from the KEK2_RK that was derived from the KEK2 keyslot, there is no longer a need for the KEK2 fuse key to persist in the keyslot. NVIDIA <span class="Emphasis">strongly</span> recommends that the key be wiped from the keyslot to prevent any component from utilizing it after the device boots.</div><div id="wwpID0E0ZE0HA" class="Body_Text">The <span class="Code_Char">hwkey-agent</span> TA demonstrates the keyslot clearing procedure. NVIDIA recommends that you use the <span class="Code_Char">se_clear_aes_keyslots()</span> function provided in the <span class="Code_Char">hwkey-agent</span> TA. This function clears several keyslots as a security precaution.</div><H4 id="wwpID0E0YE0HA" class="Heading_4">SE Usage</H4><div id="wwpID0E0XE0HA" class="Body_Text">TAs inside Trusty must use SE only during boot. Using SE from Trusty after boot may cause a system crash because there is no guarantee that the SE clocks are enabled. This means that EKB_EK must be derived and the keyslot must be cleared during boot. After booting you must utilize EKB_EK through a software crypto library.</div><H3 id="wwpID0E0WE0HA" class="Heading_3">Secure Samples</H3><div id="wwpID0E0VE0HA" class="Body_Text">The diagram below shows an overview of two secure sample applications, a CA and a TA. The CA helps users to encrypt or decrypt data with two different types of keys in the TA. The TA extracts the user-defined key from the EKB and derives another key, the Secure Storage Derived Key (SSK-derived key), from the SE SSK keyslot.</div><div class="ww_skin_page_overflow"><div id="wwpID0E0UE0HA" class="Body_Text"><img class="Default" src="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/images/image6_5.png" style="display: inline; left: 0pt; top: 0pt" alt="A screenshot of a cell phone Description automatically generated" title="A screenshot of a cell phone Description automatically generated" /></div></div><div id="wwpID0E0TE0HA" class="Body_Text">The SSK-derived key is unique on each Jetson Xavier NX, Jetson AGX Xavier, and Jetson TX2 device. Once the data is encrypted with that key, it is bound to that device. In contrast, the user-defined key is the same for each device. The CA can decide which key to use in to perform cryptographic operations in each case.</div><div id="wwpID0E0SE0HA" class="Body_Text">The following diagram describes scenarios that apply to the secure sample applications.</div><div class="ww_skin_page_overflow"><div id="wwpID0E0RE0HA" class="Body_Text"><img class="Default" src="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/images/image7_5.png" style="display: inline; left: 0pt; top: 0pt" alt="A screenshot of a cell phone Description automatically generated" title="A screenshot of a cell phone Description automatically generated" /></div></div><div id="wwpID0E0QE0HA" class="Heading_5">Client Application: hwkey-app</div><div id="wwpID0E0PE0HA" class="Body_Text">The client application (CA) is a command-line program that illustrates how to encrypt and decrypt data with the key in trusted application (TA). It offers the user two options:</div><div id="wwpID0E0OE0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Use the user-defined key stored in the EKB with the OpenSSL library in the TA.</div><div id="wwpID0E0NE0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Use the SSK in the SSK keyslot of the hardware Security Engine (SE).The application uses the <span class="Code_Char">tegra-crypto</span> library to perform cryptographic operations with the SE.</div><div id="wwpID0E0ME0HA" class="List_Continue">This option is disabled by default; you must enable it manually.</div><div id="wwpID0E0LE0HA" class="Body_Text">The CA has two major functional areas:</div><div id="wwpID0E0KE0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>OPENSSL_CRYPTO: Performs cryptographic operations with the user-defined key in the EKB, using the OpenSSL library in the TA.</div><div id="wwpID0E0JE0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>TEGRA_SE_CRYPTO: Performs cryptographic operations with the SSK in a keyslot, using the <span class="Code_Char">tegra-crypto</span> library in the CA.</div><div id="wwpID0E0IE0HA" class="Heading_5">Trusted Application: hwkey-agent</div><div id="wwpID0E0HE0HA" class="Body_Text">The TA is a background service, started at boot time, which performs key management for two keys: a user-defined key in the EKB, and an SSK-derived key. It uses cryptographic services from the OpenSSL library.</div><div id="wwpID0E0GE0HA" class="Body_Text">The TA has two major functional areas:</div><div id="wwpID0E0FE0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Key maintenance for the user-defined key and the SSK-derived key.</div><div id="wwpID0E0EE0HA" class="List_Continue">The TA derives the SSK-derived key (SSK_DK) from the SSK keyslot in the same way that it derives KEK2_DK from the KEK2 keyslot. This demonstrates how to derive keys from keyslots for security purposes. You can use the same procedure to derive an SSK_DK for your own needs.</div><div id="wwpID0E0DE0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>OPENSSL_CRYPTO: Provides an interface that can receive an IPC request with parameters that specify:</div><div id="wwpID0E0CE0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Whether to encrypt or decrypt</div><div id="wwpID0E0BE0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>A data buffer containing the plaintext to be encrypted or the ciphertext to be decrypted</div><div id="wwpID0E0AE0HA" class="List_Continue">The TA uses the user-defined key by default. To use the SE with the SSK keyslot you must enable it manually.</div><H3 id="wwpID0E06D0HA" class="Heading_3">Key Maintenance and EKBs</H3><div id="wwpID0E05D0HA" class="Body_Text">One important purpose of the sample applications is to demonstrate secure techniques for deriving keys from hardware-based fuse keys, using them for different purposes, and securing the user-defined key in the EKB.</div><div id="wwpID0E04D0HA" class="Body_Text">An EKB that holds one key looks like this:</div><div class="ww_skin_page_overflow"><table class="Table_Grid" style="background-color: #DDEEBF; margin-left: 63.9pt" cellspacing="0" summary=""><tr><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 91.9pt"><div id="wwpID0EADA03D0HA" class="Cell_Text" style="text-align: center">EKB_header<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 91.9pt"><div id="wwpID0EACA03D0HA" class="Cell_Text" style="text-align: center">EKB_cmac<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 91.9pt"><div id="wwpID0EABA03D0HA" class="Cell_Text" style="text-align: center">Random_IV<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 91.9pt"><div id="wwpID0EAAA03D0HA" class="Cell_Text" style="text-align: center">EKB ciphertext<br />(16 bytes)</div></td></tr></table></div><div id="wwpID0E02D0HA" class="Body_Text">The fields in the EKB are:</div><div id="wwpID0E01D0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>EKB header: A 16‑byte EKB header.</div><div id="wwpID0E0ZD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">EKB_cmac</span>: An authentication code based on the AES-CMAC algorithm. This is used to authenticate the EKB content of Random_IV and the EKB ciphertext.</div><div id="wwpID0E0YD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">Random_IV</span>: A random initial vector that is used for EKB content encryption and decryption.</div><div id="wwpID0E0XD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>EKB ciphertext: The encrypted user-defined key.</div><div id="wwpID0E0WD0HA" class="Body_Text">You can add additional keys to an EKB by adding additional sets of (EKB_cmac, Random_IV, EKB ciphertext) fields. You can do this by extending the script (see <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E03B0HA" title="Trusty, a Trusted Execution Environment">Tool for EKB Generation</a></span>) to support additional keys. Then the EKB layout looks like this:</div><div class="ww_skin_page_overflow"><table class="Table_Grid" style="background-color: #DDEEBF; margin-left: 38.8pt; padding-left: 1.45pt; padding-right: 1.45pt" cellspacing="0" summary=""><tr><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 85.45pt" colspan="3"><div id="wwpID0EAEE0VD0HA" class="Cell_Text" style="text-align: center">EKB_header<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 81pt" colspan="3"><div id="wwpID0EADE0VD0HA" class="Cell_Text" style="text-align: center">EKB_cmac_1<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 85.5pt"><div id="wwpID0EACE0VD0HA" class="Cell_Text" style="text-align: center">Random_IV_1<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 80.95pt" colspan="3"><div id="wwpID0EABE0VD0HA" class="Cell_Text" style="text-align: center">EKB ciphertext<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 11.799999999999999pt" colspan="3"><div id="wwpID0EAAE0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td></tr><tr><td style="background-color: #FFFFFF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 93.9pt" colspan="4"><div id="wwpID0EACD0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td><td style="background-color: #FFFFFF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 239.60000000000002pt" colspan="7"><div id="wwpID0EABD0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td><td style="background-color: #FFFFFF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 43.95pt" colspan="3"><div id="wwpID0EAAD0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td></tr><tr><td style="background-color: #FFFFFF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 72.65pt" colspan="2"><div id="wwpID0EAFC0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 12.8pt"><div id="wwpID0EAEC0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 80.05pt" colspan="2"><div id="wwpID0EADC0VD0HA" class="Cell_Text" style="text-align: center">EKB_cmac_2<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 88.25pt" colspan="3"><div id="wwpID0EACC0VD0HA" class="Cell_Text" style="text-align: center">Random_IV_2<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 78.65pt"><div id="wwpID0EABC0VD0HA" class="Cell_Text" style="text-align: center">EKB ciphertext 2<br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 11.799999999999999pt" colspan="3"><div id="wwpID0EAAC0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td></tr><tr><td style="background-color: #FFFFFF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 93.9pt" colspan="4"><div id="wwpID0EACB0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td><td style="background-color: #FFFFFF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 239.60000000000002pt" colspan="7"><div id="wwpID0EABB0VD0HA" class="Cell_Text" style="text-align: center"><span style="font-weight: bold">·<br />·<br />·</span></div></td><td style="background-color: #FFFFFF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 43.95pt" colspan="3"><div id="wwpID0EAAB0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td></tr><tr><td style="background-color: #FFFFFF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 71.95pt"><div id="wwpID0EAEA0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 13.5pt" colspan="2"><div id="wwpID0EADA0VD0HA" class="Cell_Text" style="text-align: center">&nbsp;</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 81pt" colspan="3"><div id="wwpID0EACA0VD0HA" class="Cell_Text" style="text-align: center">EKB_cmac_<span style="font-style: italic">n</span><br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 85.5pt"><div id="wwpID0EABA0VD0HA" class="Cell_Text" style="text-align: center">Random_IV_<span style="font-style: italic"> n</span><br />(16 bytes)</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 80.95pt" colspan="3"><div id="wwpID0EAAA0VD0HA" class="Cell_Text" style="text-align: center">EKB ciphertext <span style="font-style: italic">n</span><br />(16 bytes)</div></td></tr></table></div><div id="wwpID0E0UD0HA" class="Body_Text">In use, the TA uses EKB_AK to authenticate the EKB. Only if authentication succeeds, confirming that the EKB has not been modified, does it decrypt the EKB ciphertext.</div><H4 id="wwpID0E0TD0HA" class="Heading_4">KDF of Fuse Keys</H4><div id="wwpID0E0SD0HA" class="Body_Text">The fuse keys are loaded into keyslots during an early boot stage, before Trusty runs. Because software cannot read it back from the keyslots, a TA can only derive the keys from the keyslots through the AES-ECB algorithm. With the derivation key from SE, it is called the <span class="Strong">Root Key</span> (RK). An RK is not used directly for crypto operations. Use the NIST-SP-800-108 KDF recommendation to derive a <span class="Strong">Derived Key</span> (DK) and use that for further crypto operations.</div><div id="wwpID0E0RD0HA" class="Body_Text">Thus, there are two steps to getting a DK from a fuse key:</div><div id="wwpID0E0QD0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>RK = AES-ECB-128(fuse key, FV)</div><div id="wwpID0E0PD0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>DK = NIST-SP-800-108(RK)</div><div id="wwpID0E0OD0HA" class="Body_Text">The sample applications use a counter mode KDF described in NIST-SP-800-108 with a CMAC pseudo-random function (PRF).</div><div id="wwpID0E0ND0HA" class="Body_Text">A production application typically has multiple use cases that need different keys. NVIDIA strongly recommends using different keys for different purposes, using the KDF can be used to derive multiple keys.</div><div id="wwpID0E0MD0HA" class="Body_Text">This outline describes the flow of KDF generation of fuse keys:</div><div id="wwpID0E0LD0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>FV (Fixed Vector).</div><div id="wwpID0E0KD0HA" class="List_Continue">Generate the FV with a random number generator. NVIDIA recommends using <span class="Code_Char">/dev/random</span> or <span class="Code_Char">/dev/urandom</span>.</div><div id="wwpID0E0JD0HA" class="List_Continue">This command generates a 16-byte random number and displays it in hexadecimal:</div><div id="wwpID0E0ID0HA" class="Code_Indent">$ openssl rand -rand /dev/urandom -hex 16 &gt; iv_hex_file</div><div id="wwpID0E0HD0HA" class="List_Continue">The sample applications require two FVs:</div><div id="wwpID0E0GD0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">FV_for_ekb</span>: Used to derive an RK for EKB from the KEK2 keyslot.</div><div id="wwpID0E0FD0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">FV_for_ssk_dk</span>: Used to derive an RK for SSK_DK from an SSK keyslot.</div><div id="wwpID0E0ED0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>RKs (Root Keys): Derived by the formulas:</div><div id="wwpID0E0DD0HA" class="List_Continue">KEK2_RK_for_ekb = AES-128-ECB(KEK2 keyslot, FV_for_ekb)</div><div id="wwpID0E0CD0HA" class="List_Continue">SSK_RK = AES-128-ECB(SSK keyslot, FV_for_ssk_dk)</div><div id="wwpID0E0BD0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>DKs (Derived Keys): Derived by the formulas:</div><div id="wwpID0E0AD0HA" class="List_Continue">EKB_EK = NIST-SP-800-108(KEK2_RK_for_ekb, ...)</div><div id="wwpID0E06C0HA" class="List_Continue">EKB_AK = NIST-SP-800-108(KEK2_RK_for_ekb, ...)</div><div id="wwpID0E05C0HA" class="List_Continue">SSK_DK = NIST-SP-800-108(SSK_RK, ...)</div><div id="wwpID0E04C0HA" class="Heading_5">Pseudocode for NIST-SP-800-108</div><div id="wwpID0E03C0HA" class="Code">NIST-SP-800-108(KI, KO, L, context_string, label_string) {</div><div id="wwpID0E02C0HA" class="Code">   uint8_t count = 0x01;</div><div id="wwpID0E01C0HA" class="Code">   for (count=0x01; count&lt;=L/128; count++) {</div><div id="wwpID0E0ZC0HA" class="Code">      AES-128-CMAC(key=KI, count || label_string || 0x00 || context_string, output=&amp;KO[count*128]);</div><div id="wwpID0E0YC0HA" class="Code">   }</div><div id="wwpID0E0XC0HA" class="Code">}</div><div id="wwpID0E0WC0HA" class="Body_Text">Where:</div><div id="wwpID0E0VC0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">KI</span> is a 128-bit input key</div><div id="wwpID0E0UC0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">KO</span> is a 128-bit output key</div><div id="wwpID0E0TC0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">L</span> is 128, the bit length of <span class="Code_Char">KO</span>.</div><div id="wwpID0E0SC0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">context_string</span> and <span class="Code_Char">label_string</span> have the values shown in this table:</div><div class="ww_skin_page_overflow"><table class="Table_Grid" style="margin-left: 54pt" cellspacing="0" summary=""><tr><td style="background-color: #DBEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 94.25pt"><div id="wwpID0EACD0RC0HA" class="Cell_Heading">For derived key</div></td><td style="background-color: #DBEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 90pt"><div id="wwpID0EABD0RC0HA" class="Cell_Heading">context_string</div></td><td style="background-color: #DBEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 90pt"><div id="wwpID0EAAD0RC0HA" class="Cell_Heading">label_string</div></td></tr><tr><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EACC0RC0HA" class="Cell_Text">EKB_EK</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EABC0RC0HA" class="Cell_Text">"ekb"</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EAAC0RC0HA" class="Cell_Text">"encryption"</div></td></tr><tr><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EACB0RC0HA" class="Cell_Text">EKB_AK</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EABB0RC0HA" class="Cell_Text">"ekb"</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EAAB0RC0HA" class="Cell_Text">"authentication"</div></td></tr><tr><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EACA0RC0HA" class="Cell_Text">SSK_DK</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EABA0RC0HA" class="Cell_Text">"ssk"</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EAAA0RC0HA" class="Cell_Text">"derivedkey"</div></td></tr></table></div><H4 id="wwpID0E0QC0HA" class="Heading_4">EKB Generation</H4><div id="wwpID0E0PC0HA" class="Body_Text">As shown in the figure under <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E06D0HA" title="Trusty, a Trusted Execution Environment">Key Maintenance and EKBs</a></span>, the sample applications’ EKB layout is intended to help you design a mechanism that is secure enough to protect your private data in EKB blob. The sample applications store a user-defined key in the EKB. You can easily extend EKB layout, for example, by adding multiple sections for multiple keys.</div><div id="wwpID0E0OC0HA" class="Body_Text">NVIDIA strongly recommends that you use the same layout as the sample programs, or replace it with one that you know to be even more secure.</div><div id="wwpID0E0NC0HA" class="Body_Text">The following outline shows the most logical sequence of operations for creating an EKB.</div><div id="wwpID0E0MC0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>EKB ciphertext = AES-128-CBC(IV=Random_IV, Key=EKB_EK, EKB plain text)</div><div id="wwpID0E0LC0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Random_IV is the initial vector to be used to generate a new EKB blob.</div><div id="wwpID0E0KC0HA" class="List_Bullet_2" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>EKB plain text is a user-defined key in plaintext.</div><div id="wwpID0E0JC0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>EKB_cmac is the authentication code that will be used to verify if the message had been changed.</div><div id="wwpID0E0IC0HA" class="List_Continue">Compute EKB_content (an intermediate result) as:</div><div id="wwpID0E0HC0HA" class="List_Continue_2">EKB_content = Random_IV + EKB_ciphertext</div><div id="wwpID0E0GC0HA" class="List_Continue">Then compute EKB_cmac as:</div><div id="wwpID0E0FC0HA" class="List_Continue_2">EKB_cmac = AES-CMAC(Key=EKB_AK, EKB_content)</div><div id="wwpID0E0EC0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>EKB blob = EKB Header + EKB_cmac + EKB_content</div><H4 id="wwpID0E0DC0HA" class="Heading_4">EKB Extraction</H4><div id="wwpID0E0CC0HA" class="Body_Text">The following outline shows the most logical sequence of operations for extracting information from an EKB. It is essentially the reverse of the process for EKB generation. </div><div id="wwpID0E0BC0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Compute the CMAC:</div><div id="wwpID0E0AC0HA" class="List_Continue">AES-CMAC_verify(EKB_cmac, Key=EKB_AK, EKB_content)</div><div id="wwpID0E06B0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Compare the computed CMAC to the CMAC in the EKB. If they match, proceed.</div><div id="wwpID0E05B0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Compute the EKB plaintext:</div><div id="wwpID0E04B0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>EKB_plaintext = AES-128-CBC_decrypt(IV=Random_IV, Key=EKB_EK, EKB_ciphertext)</div><H4 id="wwpID0E03B0HA" class="Heading_4">Tool for EKB Generation</H4><div id="wwpID0E02B0HA" class="Body_Text">Before generating the EKB blob, refer to the <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/bootloader_secure_boot.html#" title="Secureboot">Secureboot</a></span> topic for information about burning keys into fuses, including the KEK2 fuse, and the secure boot requirements for using Trusty on Jetson devices.</div><div id="wwpID0E01B0HA" class="Body_Text">As <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/trusty.html#wwpID0E0TD0HA" title="Trusty, a Trusted Execution Environment">KDF of Fuse Keys</a></span> explains, you can generate the fixed vector (FV) or the user-defined key with a command line that runs the <span class="Code_Char">openssl</span> tool. You can generate these items separately and store them in different files.</div><div id="wwpID0E0ZB0HA" class="Body_Text">Note that FVs must be the same for EKB extraction as for EKB generation. Exercise due caution to keep the FVs confidential.</div><div id="wwpID0E0YB0HA" class="Body_Text">This example shows how to run the EKB generation tool:</div><div id="wwpID0E0XB0HA" class="Code">$ python3 gen_ekb.py -kek2_key &lt;kek2_fuse_key_file&gt; \</div><div id="wwpID0E0WB0HA" class="Code">    -fv &lt;fv_for_ekb_ek&gt; \</div><div id="wwpID0E0VB0HA" class="Code">    -in_sym_key &lt;sym_key_file&gt; \</div><div id="wwpID0E0UB0HA" class="Code">    -in sym_key2 &lt;sym2_key_file&gt; \</div><div id="wwpID0E0TB0HA" class="Code">    -out &lt;eks_image_file&gt;</div><div id="wwpID0E0SB0HA" class="Body_Text">Where:</div><div id="wwpID0E0RB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">&lt;kek2_fuse_key_file&gt;</span> is the key that is stored in the KEK2 fuse.</div><div id="wwpID0E0QB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">&lt;fv_for_ekb_ek&gt;</span> is a fixed vector (FV) for deriving an RK from the KEK2 fuse. It must be the same as the FV used in <span class="Code_Char">hwkey-agent</span> to derive the KEK2 RK for EKB encryption and decryption.</div><div id="wwpID0E0PB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">&lt;sym_key_file&gt;</span> is the kernel encryption key.</div><div id="wwpID0E0OB0HA" class="List_Continue">The key must be the same as the user key used in the flash command. (See the section <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/bootloader_secure_boot.html#wwconnect_header" title="Secureboot">To sign and flash in one step using the user, SBK, and PKC keys</a></span> of the topic <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/bootloader_secure_boot.html#" title="Secureboot">Secureboot</a></span>.) The encrypt key must be the same as the encrypt key used to encrypt custom-built kernel images. (See the section <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/bootloader_secure_boot.html#wwpID0ESHA" title="Secureboot">Signing and Encrypting Kernel, Kernel-DTB, and Initrd Binary Files</a></span> in the same topic.)</div><div id="wwpID0E0NB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">&lt;sym2_key_file&gt;</span> is the disk encryption key.</div><div id="wwpID0E0MB0HA" class="List_Continue">This key is used in two reference implementations. One is the secure sample implemented by <span class="Code_Char">hwkey-agent</span> and <span class="Code_Char">hwkey-app</span>. This sample uses the key for data encryption and decryption. In another case, the key is the source key of the key generation of the LUKS key in the disk encryption reference implementation.</div><div id="wwpID0E0LB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span><span class="Code_Char">&lt;eks_image_file&gt;</span> is an image file generated from the Encrypted Binary Blob (EKB) file by the EKB generation tool. The output binary blob file is intended to be flashed onto the EKS partition of the device.</div><H4 id="wwpID0E0KB0HA" class="Heading_4">EKB Extraction Sample</H4><div id="wwpID0E0JB0HA" class="Body_Text">For an example of how to perform EKB extraction, see the source code for the <span class="Code_Char">hwkey-agent</span> trusted application.</div><H3 id="wwpID0E0IB0HA" class="Heading_3"> Hardware Random Number Generator Function</H3><div id="wwpID0E0HB0HA" class="Body_Text">Many use cases need a secure random number source for key or password generation, network protocols, cryptographic processes, etc. Jetson processors provides a hardware-based random number source through in Linux device node <span class="Code_Char">/dev/random</span> (which blocks until the kernel has accumulated enough entropic data to return the requested amount of random data) or <span class="Code_Char">/dev/urandom</span> (which does not block).</div><div id="wwpID0E0GB0HA" class="Body_Text">Trusty provides an alternative source in the secure world, the Trusty random number generator (RNG). It is compliant with the NIST-SP 800-90 a/b/c draft specifications. It can reseed itself, and generates numbers that are truly random and uniformly distributed over the range of results.</div><div id="wwpID0E0FB0HA" class="Body_Text">A TA can provide an RNG service that the CA or other TAs can communicate with it to acquire random numbers.</div><div id="wwpID0E0EB0HA" class="Body_Text">This diagram shows the architecture of the Trusty RNG and how random numbers can be extracted from the secure world.</div><div id="wwpID0E0DB0HA" class="Body_Text">The service model of the RNG function is:</div><div class="ww_skin_page_overflow"><div id="wwpID0E0CB0HA" class="Body_Text"><img class="Default" src="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/images/image8_4.png" style="display: inline; left: 0pt; top: 0pt" alt="Diagram Description automatically generated" title="Diagram Description automatically generated" /></div></div><div id="wwpID0E0BB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>During TA initialization the <span class="Code_Char">hwkey-agent</span> TA creates the <span class="Code_Char">rng-srv</span> service, an IPC channel that can receive and return random number requests from other applications.</div><div id="wwpID0E0AB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Other applications in either the normal or the secure world can request random numbers from <span class="Code_Char">rng-srv</span> by initializing an IPC channel to extract random numbers from the <span class="Code_Char">hwkey-agent</span> TA.</div><div id="wwpID0E6HA" class="List_Continue">The Trusty source code includes a sample function named <span class="Code_Char">get_random()</span> which returns random numbers obtained in this way. See the source file at <span class="Code_Char">$TRUSTY_TOP/app/nvidia-sample/hwkey-agent/CA_sample/hwkey-app.c</span>.</div><div id="wwpID0E5HA" class="Body_Text"><span class="Code_Char">rng-srv</span> uses the hardware security engine (SE) RNG1 to generate random numbers. These numbers are compliant with the NIST-SP 800-90 a/b/c draft specifications.</div><div id="wwpID0E4HA" class="Body_Text">An RNG IPC packet’s definition is:</div><div id="wwpID0E3HA" class="Code">#define RNG_SRV_DATA_SIZE 2048</div><div id="wwpID0E2HA" class="Code">typedef struct rng_srv_msg {</div><div id="wwpID0E1HA" class="Code">    uint32_t rng_size;</div><div id="wwpID0EZHA" class="Code">    uint8_t rng_data[RNG_SRV_DATA_SIZE];</div><div id="wwpID0EYHA" class="Code">};</div><div id="wwpID0EXHA" class="Body_Text">The maximum length of random numbers the RNG function can return is 2048 bytes. If you need random numbers that are longer than that, query multiple times and concatenate the results to the length you need.</div><H3 id="wwpID0EWHA" class="Heading_3">AES-256 Hardware Key Derivation Function in Trusty OS</H3><div id="wwpID0EVHA" class="Body_Text">A Jetson Linux trusted OS (TOS) has a hardware-based Key Derivation Function (KDF) which you can use to derive keys from the Key Encryption Key (ODM KEK) fuses.</div><H4 id="wwpID0EUHA" class="Heading_4">Flow of the AES-256 Hardware KDF</H4><div id="wwpID0ETHA" class="Body_Text">This diagram shows the flow of key derivation from the ODM KEK fuse.</div><div class="ww_skin_page_overflow"><div id="wwpID0ESHA" class="Body_Text"><img class="Default" src="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/images/image9_4.png" style="display: inline; left: 0pt; top: 0pt" alt="Diagram Description automatically generated" title="Diagram Description automatically generated" /></div></div><div id="wwpID0ERHA" class="Body_Text">You can address and load the ODM KEK fuses <span class="Code_Char">KEK0</span> and <span class="Code_Char">KEK1</span> as separate 128‑bit fuses or as a single 256‑bit fuse, as shown in this table:</div><div class="ww_skin_page_overflow"><table class="Table_Grid" style="margin-left: 41.4pt" cellspacing="0" summary=""><tr><td style="background-color: #DBEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 396pt" colspan="4"><div id="wwpID0EAAFQHA" class="Cell_Heading">ODM KEK fuses related to Secureboot<br />Jetson Xavier NX, Jetson AGX Xavier series, and Jetson TX2 series devices</div></td></tr><tr><td style="background-color: #DBEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 49.5pt"><div id="wwpID0EADEQHA" class="Cell_Heading">Bit size</div></td><td style="background-color: #DBEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 54pt"><div id="wwpID0EACEQHA" class="Cell_Heading">Name</div></td><td style="background-color: #DBEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 54pt"><div id="wwpID0EABEQHA" class="Cell_Heading">Key slot</div></td><td style="background-color: #DBEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 238.5pt"><div id="wwpID0EAAEQHA" class="Cell_Heading">Default value set by odmfuse.sh</div></td></tr><tr><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EADDQHA" class="Cell_Text" style="text-align: center">128</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EACDQHA" class="Cell_Text">KEK0</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EABDQHA" class="Cell_Text" style="text-align: center">13</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EAADQHA" class="Cell_Text">Four 32<span style="font-family: &quot;Cambria Math&quot;">‑</span>bit registers named KEK00 through KEK03.</div></td></tr><tr><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EADCQHA" class="Cell_Text" style="text-align: center">128</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EACCQHA" class="Cell_Text">KEK1</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EABCQHA" class="Cell_Text" style="text-align: center">12</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EAACQHA" class="Cell_Text">Four 32<span style="font-family: &quot;Cambria Math&quot;">‑</span>bit registers named KEK10 through KEK13.</div></td></tr><tr><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EADBQHA" class="Cell_Text" style="text-align: center">256</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EACBQHA" class="Cell_Text">KEK256</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EABBQHA" class="Cell_Text" style="text-align: center">13</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EAABQHA" class="Cell_Text">Not a distinct fuse; addresses KEK0 and KEK1 as a single 256<span style="font-family: &quot;Cambria Math&quot;">‑</span>bit fuse.</div></td></tr><tr><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EADAQHA" class="Cell_Text" style="text-align: center">128</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EACAQHA" class="Cell_Text">KEK2</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EABAQHA" class="Cell_Text" style="text-align: center">11</div></td><td style="background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top"><div id="wwpID0EAAAQHA" class="Cell_Text">Four 32<span style="font-family: &quot;Cambria Math&quot;">‑</span>bit registers named KEK20 through KEK23.</div></td></tr></table></div><div id="wwpID0EPHA" class="Body_Text">The <span class="Code_Char">BctKEKKeySelect</span> flag in the BootROM Boot Configuration Table (BR-BCT) determines how BootROM loads KEK0 and KEK1 into the Security Engine (SE) keyslot(s):</div><div id="wwpID0EOHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>If the flag is set to 0, BootROM loads the <span class="Code_Char">KEK0</span> and <span class="Code_Char">KEK1</span> fuses as two 128‑bit keys.</div><div id="wwpID0ENHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>If the flag is set to 1, BootROM loads the fuses as a single 256‑bit key.</div><div id="wwpID0EMHA" class="Body_Text">BootROM loads the BR BCT from a configuration file that is stored in the directory at <span class="Code_Char">${Linux_for_Tegra_folder}/‌bootloader/‌t186ref/‌BCT/</span>. The file’s name is:</div><div id="wwpID0ELHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>For Jetson Xavier NX: <span class="Code_Char">tegra194-br-bct-qspi.cfg</span></div><div id="wwpID0EKHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>For Jetson AGX Xavier series: <span class="Code_Char">tegra194-br-bct-sdmmc.cfg</span></div><div id="wwpID0EJHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>For Jetson TX2 series: <span class="Code_Char">emmc.cfg</span></div><div id="wwpID0EIHA" class="Body_Text">To set the flag to 1, for example:</div><div id="wwpID0EHHA" class="Code">BctKEKKeySelect = 1;</div><div id="wwpID0EGHA" class="Body_Text">After BootROM identifies the key provision source from a setting in BR BCT, you can use the hardware-based NIST-SP 800-108 KDF to derive keys from the ODM KEK fuse. The KDF generates the derived keys.</div><div id="wwpID0EFHA" class="Body_Text">The <span class="Code_Char">odmfuse.sh</span> script can use the options <span class="Code_Char">--KEK0</span> and <span class="Code_Char">--KEK1</span> to burn <span class="Code_Char">KEK0</span> and <span class="Code_Char">KEK1</span> as separate 128-bit keys, or the option <span class="Code_Char">--KEK256</span> to burn them as a single 256-bit key.</div><H4 id="wwpID0EEHA" class="Heading_4">API Functions</H4><div id="wwpID0EDHA" class="Body_Text">Jetson Linux supports two APIs for hardware-based random number generation.</div><div id="wwpID0ECHA" class="Body_Text">The hardware-based AES-CMAC functions are very similar to those in the <span class="Hyperlink"><a href="https://man.archlinux.org/man/community/libressl/libressl-CMAC_Init.3.en" target="external_window">OpenSSL CMAC</a></span> implementation. See <span class="Hyperlink"><a href="https://docs.nvidia.com/jetson/l4t-multimedia/group__trusty__aes__cmac__group.html" target="external_window">Hardware-Based AES-CMAC Functions</a></span> for details.</div><div id="wwpID0EBHA" class="Body_Text">The NIST 800-108 key definition functions implement the counter-mode KDF as defined in NIST-SP 800-108. See <span class="Hyperlink"><a href="https://docs.nvidia.com/jetson/l4t-multimedia/l4t_mm_html/group__trusty__nist__800__108__group.html" target="external_window">NIST 800-108 Key Definition Functions</a></span> for details.</div></div><div id="page_dates"></div><!-- Related Topics --><!--                --><footer><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><br /></footer></div></div><input type="hidden" id="preserve_unknown_file_links" value="false"></input><noscript><div id="noscript_warning">This site works best with JavaScript enabled</div></noscript><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></body></html>