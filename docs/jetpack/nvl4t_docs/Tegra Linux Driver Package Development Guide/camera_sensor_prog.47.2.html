<!DOCTYPE html ><html xml:lang="en" lang="en" data-highlight-require-whitespace="false" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><!-- NVIDIA customization --><title>NVIDIA Jetson Linux Driver Package Software Features : Camera Development | NVIDIA Docs </title><link rel="Prev" href="camera_sensor_prog.47.1.html" title="Previous" /><link rel="Next" href="gmsl_camera_framework.html" title="Next" /><link rel="StyleSheet" href="../css/font-awesome/css/font-awesome.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/camera_sensor_prog.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/social.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/print.css" type="text/css" media="print" /><noscript><div id="noscript_padding"></div></noscript></head><body id="pR2qZAUvRzcoTJWtpNjE1hw" class="ww_skin_page_body" style="visibility: hidden;"><input type="hidden" id="page_onload_url" value="../index.html#page/Tegra%20Linux%20Driver%20Package%20Development%20Guide/camera_sensor_prog.47.2.html"></input><span id="dropdown_ids" style="display:none;"></span><div id="ww_content_container"><header id="wwconnect_header"><div class="ww_skin_page_toolbar"><div id="dropdown_button_container" class="dropdown_container dropdown_button_container_disabled"><a id="show_hide_all" class="ww_skin ww_behavior_dropdown_toggle ww_skin_dropdown_toggle" title="Page DropDown Toggle" href="#"><i class="fa"></i></a><span class="ww_skin_page_toolbar_divider">&nbsp;</span></div><a class="ww_behavior_print ww_skin ww_skin_print" title="Print" href="#"><i class="fa"></i></a></div><!-- was this helpful button --><!--                         --></header><div id="page_content_container" style="background-attachment: scroll; background-image: url(&quot;watermark.png&quot;); background-position: center center; background-repeat: no-repeat; margin-left: 0pt; margin-right: 10pt; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px"><div id="page_content"><H1 id="wwpID0E0MG0HA" class="Heading_4_Top">Using the Jetson-IO Tool</H1><div id="wwpID0E0LG0HA" class="Body_Text">If your camera module does not have an on-board EEPROM, you can create a DTB overlay file to statically configure the board for the attached camera. When you attach your camera module, apply the camera module DTB overlay using the <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/hw_setup_jetson_io.html#" title="Configuring Jetson Expansion Header">Jetson‑IO tool</a></span>, then reboot. The new module works as soon as Jetson Linux starts.</div><div id="wwpID0E0KG0HA" class="Heading_5">To create and apply a DTB overlay file</div><div id="wwpID0E0JG0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Add your <span class="Code_Char">.dtsi</span> file to the jetson board <span class="Code_Char">.dts</span> file.</div><div id="wwpID0E0IG0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Set the status of your device tree nodes to “disabled”:</div><div id="wwpID0E0HG0HA" class="Code">imx185_cam0: imx185_a@1a {</div><div id="wwpID0E0GG0HA" class="Code">status = "disabled";</div><div id="wwpID0E0FG0HA" class="Code">};</div><div id="wwpID0E0EG0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Add the override information to a new <span class="Code_Char">.dts</span> file, for example:</div><div id="wwpID0E0DG0HA" class="Code">&lt;top&gt;/hardware/nvidia/platform/t19x/common/kernel-dts/t19x-common-modules/tegra194-camera-overlay-file.dts</div><div id="wwpID0E0CG0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>Update the <span class="Code_Char">.dtbo</span> file with proper override information and a <span class="Code_Char">compatible</span> string:</div><div id="wwpID0E0BG0HA" class="Code">compatible = "nvidia,p3449-0000+p3668-0000", "nvidia,p3449-0000+p3668-0001", "nvidia,p3509-0000+p3668-0000", "nvidia,p3509-0000+p3668-0001";</div><div id="wwpID0E0AG0HA" class="Code">&nbsp;</div><div id="wwpID0E06F0HA" class="Code">fragment@0 {</div><div id="wwpID0E05F0HA" class="Code">    target = &lt;&amp;imx185_cam0&gt;;</div><div id="wwpID0E04F0HA" class="Code">    __overlay__ {</div><div id="wwpID0E03F0HA" class="Code">        status = "okay";</div><div id="wwpID0E02F0HA" class="Code">    };</div><div id="wwpID0E01F0HA" class="Code">};</div><div id="wwpID0E0ZF0HA" class="List_Continue">For detailed information about writing DTB overlay files with Jetson‑IO, see the section <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/hw_setup_jetson_io.html#" title="Configuring Jetson Expansion Header">Running Jetson-IO</a></span> in the topic <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/hw_setup.html#" title="Hardware Setup">Hardware Setup</a></span>.</div><div id="wwpID0E0YF0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>5.	</span></span>Compile the <span class="Code_Char">.dts</span> file to generate a <span class="Code_Char">.dtbo</span> file. Move the <span class="Code_Char">.dtbo</span> file to <span class="Code_Char">/boot</span> so that the Jetson‑IO tool can recognize it. Launch the Jetson‑IO tool and configure the DTB overlay.</div><H4 id="wwpID0E0XF0HA" class="Heading_4">Using the Main Platform Device Tree File</H4><div id="wwpID0E0WF0HA" class="Body_Text">Register your new device by updating the main platform <span class="Code_Char">.dtsi</span> file to include your new device <span class="Code_Char">.dtsi</span> file. Because Jetson devices use Plugin Manager by default, you must first unregister Plugin Manager support, then add your device information to the main device tree <span class="Code_Char">.dtsi</span> file.</div><div id="wwpID0E0VF0HA" class="Heading_5">To register a device using the main platform device tree file</div><div id="wwpID0E0UF0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Locate and edit the <span class="Code_Char">.dtsi</span> file:</div><div id="wwpID0E0TF0HA" class="Code">&lt;top&gt;/hardware/nvidia/platform/t19x/galen/kernel-dts/tegra194-p2888-0001-p2822-0000.dtsi</div><div id="wwpID0E0SF0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Remove the following line from the file:</div><div id="wwpID0E0RF0HA" class="Code">#include "tegra194-camera-plugin-manager.dtsi"</div><div id="wwpID0E0QF0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Replace the following line:</div><div id="wwpID0E0PF0HA" class="Code">#include "common/tegra194-p2822-camera-modules.dtsi"</div><div id="wwpID0E0OF0HA" class="List_Continue">With an <span class="Code_Char">#include</span> statement specifying the DTSI file for your new device.</div><div id="wwpID0E0NF0HA" class="List_Continue">Save and close the file.</div><div class="ww_skin_page_overflow"><table class="Table_Normal" style="margin-left: 18pt" cellspacing="0" summary=""><tr><td style="background-color: #76B900; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 49.5pt"><div id="wwpID0EABA0MF0HA" class="Note_Heading">Note:</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 364.5pt"><div id="wwpID0EAAA0MF0HA" class="Note_Text">Use <span class="Code_Char">tegra194-p2822-camera-modules.dtsi</span> as a model for generating your DTSI. In your file, change <span class="Code_Char">status = disable</span> to <span class="Code_Char">status = okay</span>.</div></td></tr></table></div><H3 id="wwpID0E0LF0HA" class="Heading_3">Verifying the V4L2 Sensor Driver</H3><div id="wwpID0E0KF0HA" class="Body_Text">When the driver is complete, run <span class="Code_Char">v4l2-compliance</span> and <span class="Code_Char">v4l2-ctl</span> to ensure that it can capture raw data through the V4L2 interface.</div><div id="wwpID0E0JF0HA" class="Body_Text">For details on RAW memory format, see the “Video Input” topic in:</div><div id="wwpID0E0IF0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt; font-style: normal">•	</span></span>For Jetson Nano series and Jetson TX1: <span class="Emphasis">Tegra X1 (SoC) Technical Referene Manual</span></div><div id="wwpID0E0HF0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>For Jetson TX2: <span class="Emphasis">Tegra X2 (Parker Series SoC) Technical Reference Manual</span></div><div id="wwpID0E0GF0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>For Jetson AGX Xavier series: <span class="Emphasis">Jetson AGX Xavier Technical Reference Manual</span></div><div id="wwpID0E0FF0HA" class="Heading_5">To run a v4l2-compliance test</div><div id="wwpID0E0EF0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>Enter the command:</div><div id="wwpID0E0DF0HA" class="Code">v4l2-compliance -d /dev/video&lt;n&gt;</div><div id="wwpID0E0CF0HA" class="List_Continue">Where <span class="Code_Char">&lt;n&gt;</span> is the number of the camera that the test is to use.</div><div id="wwpID0E0BF0HA" class="List_Continue">If your system has one camera, <span class="Code_Char">&lt;n&gt;</span> is 0, i.e. the device path is <span class="Code_Char">/dev/video0</span>.</div><div id="wwpID0E0AF0HA" class="List_Continue">If your system has multiple cameras, specify the index of the camera you want to use for the test.</div><div id="wwpID0E06E0HA" class="Heading_5">To run a v4l2-ctl test</div><div id="wwpID0E05E0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>Enter the command:</div><div id="wwpID0E04E0HA" class="Code">v4l2-ctl --set-fmt-video=width=1920,height=1080,pixelformat=RG12 --stream-mmap --set-ctrl=sensor_mode=0 --stream-count=100 -d /dev/video&lt;n&gt;</div><div id="wwpID0E03E0HA" class="List_Continue">Where <span class="Code_Char">&lt;n&gt;</span> is the same as for <span class="Code_Char">v4l2-compliance</span>, above.</div><div id="wwpID0E02E0HA" class="Body_Text">You can use <span class="Code_Char">v4l2-ctl</span> to capture RAW data by specifying the <span class="Code_Char">‑‑stream-count</span> switch for frames to capture and the <span class="Code_Char">‑‑stream-to</span> switch for the output path.</div><div id="wwpID0E01E0HA" class="Body_Text">Both <span class="Code_Char">v4l2-compliance</span> and <span class="Code_Char">v4l2-ctl</span> are available as open source projects. Documentation for these commands is available from LinuxTV at:</div><div id="wwpID0E0ZE0HA" class="Code"><a href="https://www.linuxtv.org/wiki/index.php/V4l-utils" target="external_window">https://www.linuxtv.org/wiki/index.php/V4l-utils</a></div><H3 id="wwpID0E0YE0HA" class="Heading_3">Debugging Tips</H3><div id="wwpID0E0XE0HA" class="Body_Text">When the driver is ready for testing, before running any camera applications, check to see if the camera device tree node(s) are populated correctly in the system.</div><div id="wwpID0E0WE0HA" class="Body_Text">If the driver is populated properly, the name of the camera’s device tree node is displayed:</div><div id="wwpID0E0VE0HA" class="Code">/dev/video&lt;n&gt;</div><div id="wwpID0E0UE0HA" class="Body_Text">Where <span class="Code_Char">&lt;n&gt;</span> is the index of the device tree node.</div><div id="wwpID0E0TE0HA" class="Body_Text">Any problems in the probing process require debugging. Typically, problems occur in the clock, GPIO, and regulator setup.</div><div id="wwpID0E0SE0HA" class="Heading_5">To verify that driver name matches the name in the Device Tree</div><div id="wwpID0E0RE0HA" class="Body_Text">The device' name must be the same in the device tree and your driver. This is how kernel binds the driver to your device.</div><div id="wwpID0E0QE0HA" class="Body_Text">In the device tree:</div><div id="wwpID0E0PE0HA" class="Code">compatible = "nvidia,imx185";</div><div id="wwpID0E0OE0HA" class="Body_Text">In your driver:</div><div id="wwpID0E0NE0HA" class="Code">static struct of_device_id imx185_of_match[] = {</div><div id="wwpID0E0ME0HA" class="Code">{ .compatible = "nvidia,imx185", },</div><div id="wwpID0E0LE0HA" class="Code">{ },</div><div id="wwpID0E0KE0HA" class="Code">};</div><div id="wwpID0E0JE0HA" class="Code">…</div><div id="wwpID0E0IE0HA" class="Code">.driver = {</div><div id="wwpID0E0HE0HA" class="Code">     .name = "imx185",</div><div id="wwpID0E0GE0HA" class="Code">     .owner = THIS_MODULE,</div><div id="wwpID0E0FE0HA" class="Code">     .of_match_table = of_match_ptr(imx185_of_match),</div><div id="wwpID0E0EE0HA" class="Code">},</div><div id="wwpID0E0DE0HA" class="Heading_5">To verify that all device names match the device tree</div><div id="wwpID0E0CE0HA" class="Body_Text">Verify that the device names read through <span class="Code_Char">parse_dt()</span>match those in the device tree.</div><div id="wwpID0E0BE0HA" class="Heading_5">To verify that the Device tree values match the hardware</div><div id="wwpID0E0AE0HA" class="Body_Text">Ensure that the values assigned to the device tree fields match the hardware they describe. If regulator names, GPIO numbers, or clock names are out of date in the device tree, probing fails.</div><div id="wwpID0E06D0HA" class="Body_Text">Use the device tree compiler (<span class="Code_Char">dtc</span>) to convert your <span class="Code_Char">.dtb</span> file back to <span class="Code_Char">.dtsi</span> format, and examine the content. Ensure that your device tree node’s <span class="Code_Char">status</span> field is set to the proper state.</div><div id="wwpID0E05D0HA" class="Heading_5">To verify that functions run to completion</div><div id="wwpID0E04D0HA" class="Body_Text">Make sure that all functions run to completion. Pay special attention to kernel logs, and look for any errors that could cause a function to exit unexpectedly.</div><div id="wwpID0E03D0HA" class="Body_Text">It’s good practice to make your code print an error message at any point where it could fail. A silent failure is harder to catch.</div><div id="wwpID0E02D0HA" class="Heading_5">To verify that default values are correctly linked</div><div id="wwpID0E01D0HA" class="Body_Text">Verify that default values are all linked correctly in the control configuration. Also, verify that the default macros are updated appropriately with the values in the mode tables of the sensor.</div><div id="wwpID0E0ZD0HA" class="Body_Text">For more information, see <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/camera_sensor_prog.47.2.html#wwpID0EBHA" title="Using the Jetson-IO Tool">Sensor-Private Data</a></span> and <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/camera_sensor_prog.47.1.html#wwpID0E03O0HA" title="Sensor Software Driver Programming">Macro Definitions</a></span>.</div><div id="wwpID0E0YD0HA" class="Body_Text">If new controls have been added to the control configuration list, make sure that they contain the appropriate control handlers and default values.</div><div id="wwpID0E0XD0HA" class="Body_Text">After probing succeeds, problems may still occur with the control setting. A common problem is incorrect values in the register writes.</div><div id="wwpID0E0WD0HA" class="Heading_5">To verify that control register values are correct</div><div id="wwpID0E0VD0HA" class="Body_Text">Make sure that the control register setup contains the correct register address and formats according to the mode tables and data sheets. For more information, see <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/camera_sensor_prog.47.2.html#wwpID0EBHA" title="Using the Jetson-IO Tool">Setting Up Control Registers</a></span>.</div><div id="wwpID0E0UD0HA" class="Heading_5">To verify that mode-specific settings are correct</div><div id="wwpID0E0TD0HA" class="Body_Text">Double check the mode-specific settings in the device tree, and update them if necessary. The most common issues cause sensor timeout due to incorrect values for these settings:</div><div id="wwpID0E0SD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span><span class="Code_Char">num_lanes</span> must be 1, 2, or 4, depending on your sensor configuration.</div><div id="wwpID0E0RD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span><span class="Code_Char">tegra_sinterface</span> must be set to the CSI port where the sensor is connected.</div><div id="wwpID0E0QD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span><span class="Code_Char">discontinuous_clk</span> must specify that the sensor is running in continuous clock mode (free running) or discontinuous clock mode (gated). If unsure, first set this value to <span class="Code_Char">no</span>.</div><div id="wwpID0E0PD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span><span class="Code_Char">mclk_multiplier</span> must be equal or greater than <span class="Code_Char">pix_clk_hz&nbsp;/ mclk</span> to ensure that the ISP runs fast enough to process data from sensor.</div><div id="wwpID0E0OD0HA" class="Heading_5">To verify that I2C accesses are working properly</div><div id="wwpID0E0ND0HA" class="Body_Text">Examine the kernel logs closely for I2C errors associated with the camera sensor. If there are I2C errors, check the <span class="Code_Char">power_on()</span> function to verify that the sensor power-on sequence is correct. The order of enabling power, clock, GPIO, and timing must comply with sensor specifications.</div><div id="wwpID0E0MD0HA" class="Heading_5">Configuring the Sensor Driver as a Loadable Kernel Module (LKM)</div><div id="wwpID0E0LD0HA" class="Body_Text">Configuring the sensor driver as a loadable kernel module can speed up development by eliminating the need to reflash the kernel image to the Jetson device.  For more information, see <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/camera_sensor_prog.47.1.html#wwpID0E0BI0HA" title="Sensor Software Driver Programming">Loadable Kernel Module (LKM)</a></span>.</div><H3 id="wwpID0E0KD0HA" class="Heading_3">Mode Tables</H3><div id="wwpID0E0JD0HA" class="Body_Text">The register’s mode tables reside in a separate header file named <span class="Code_Char">sensor_mode_tbls.h</span>, and are included by the main driver. Those tables can be a list of <span class="Code_Char">reg_8</span> or <span class="Code_Char">reg_16</span> address-value pairs. Mode tables are separated by resolution.</div><div id="wwpID0E0ID0HA" class="Body_Text">The start and stop stream-register values must be in separate mode tables. When you separate them, delete the start stream-register values at the end of the resolution mode tables.</div><div id="wwpID0E0HD0HA" class="Code">static imx185_reg imx185_start[] = {</div><div id="wwpID0E0GD0HA" class="Code">    {0x3000, 0x00 },</div><div id="wwpID0E0FD0HA" class="Code">    {IMX185_TABLE_WAIT_MS, IMX185_WAIT_MS_START},</div><div id="wwpID0E0ED0HA" class="Code">    {0x3002, 0x00},</div><div id="wwpID0E0DD0HA" class="Code">    {0x3049, 0x02},</div><div id="wwpID0E0CD0HA" class="Code">    {IMX185_TABLE_WAIT_MS, IMX185_WAIT_MS_STREAM},</div><div id="wwpID0E0BD0HA" class="Code">    {IMX185_TABLE_END, 0x00 }</div><div id="wwpID0E0AD0HA" class="Code">};</div><div id="wwpID0E06C0HA" class="Code">&nbsp;</div><div id="wwpID0E05C0HA" class="Code">static imx185_reg imx185_stop[] = {</div><div id="wwpID0E04C0HA" class="Code">    {0x3000, 0x01 },</div><div id="wwpID0E03C0HA" class="Code">    {IMX185_TABLE_WAIT_MS, IMX185_WAIT_MS_STOP},</div><div id="wwpID0E02C0HA" class="Code">    {IMX185_TABLE_END, 0x00 }</div><div id="wwpID0E01C0HA" class="Code">};</div><div id="wwpID0E0ZC0HA" class="Body_Text">Also, a table for the color bars of the test pattern is used if the <span class="Code_Char">test_mode</span> flag is enabled, activating the test-pattern mode of the sensor. That table is required only if the sensor supports test patterns.</div><div id="wwpID0E0YC0HA" class="Code">static imx185_reg tp_colorbars[] = {</div><div id="wwpID0E0XC0HA" class="Code">    ...</div><div id="wwpID0E0WC0HA" class="Code">};</div><div id="wwpID0E0VC0HA" class="Body_Text">At the end of the mode table header file is an enumeration of all the mode tables and a list that maps the enumeration to table pointers.</div><div id="wwpID0E0UC0HA" class="Code">enum {</div><div id="wwpID0E0TC0HA" class="Code">    IMX185_MODE_1920X1080_CROP_30FPS,</div><div id="wwpID0E0SC0HA" class="Code">    ...</div><div id="wwpID0E0RC0HA" class="Code">};</div><div id="wwpID0E0QC0HA" class="Code">static oimx185_reg *mode_table[] = {</div><div id="wwpID0E0PC0HA" class="Code">    [IMX185_MODE_1920X1080_CROP_30FPS] = imx185_1920x1080_crop_30fps,</div><div id="wwpID0E0OC0HA" class="Code">    ...</div><div id="wwpID0E0NC0HA" class="Code">};</div><div id="wwpID0E0MC0HA" class="Body_Text">&nbsp;</div><div class="ww_skin_page_overflow"><table class="Table_Normal" style="margin-left: 31.5pt" cellspacing="0" summary=""><tr><td style="background-color: #76B900; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 49.5pt"><div id="wwpID0EABA0LC0HA" class="Note_Heading">Note:</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 351pt"><div id="wwpID0EAAA0LC0HA" class="Note_Text">The modes list in the table must match the modes listed in sensor device tree <span class="Code_Char">.dtsi</span> file.</div></td></tr></table></div><div id="wwpID0E0KC0HA" class="Body_Text">The <span class="Code_Char">camera_common_frmfmt</span> array sets up the format for the V4L2 framework. Each element in the array contains the mode’s resolutions, <span class="Code_Char">is_hdr</span> flag, and enumeration.</div><div id="wwpID0E0JC0HA" class="Code">static const struct camera_common_frmfmt imx185_frmfmt[] = {</div><div id="wwpID0E0IC0HA" class="Code">    {{1920, 1080}, 0, IMX185_MODE_1920X1080_CROP_30FPS},</div><div id="wwpID0E0HC0HA" class="Code">    ...</div><div id="wwpID0E0GC0HA" class="Code">};</div><div id="wwpID0E0FC0HA" class="Heading_5">To add a register mode table</div><div id="wwpID0E0EC0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Obtain the address-value pairs for the mode table you want to add.</div><div class="ww_skin_page_overflow"><table class="Table_Normal" style="margin-left: 54pt" cellspacing="0" summary=""><tr><td style="background-color: #76B900; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 49.5pt"><div id="wwpID0EABA0DC0HA" class="Note_Heading">Note:</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 346.5pt"><div id="wwpID0EAAA0DC0HA" class="Note_Text">If separate stream-on and stream-off mode tables exist, you may omit them from the mode table.</div></td></tr></table></div><div id="wwpID0E0CC0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Format the pairs according to the register structure and initialize a static array with the mode resolution as part of the name. For example:</div><div id="wwpID0E0BC0HA" class="Code_Indent">static imx185_reg mode_####x####[] = {</div><div id="wwpID0E0AC0HA" class="Code_Indent">{ 0x3000, 0x00 },</div><div id="wwpID0E06B0HA" class="Code_Indent">...</div><div id="wwpID0E05B0HA" class="Code_Indent">/* your addr and val pairs */</div><div id="wwpID0E04B0HA" class="Code_Indent">};</div><div id="wwpID0E03B0HA" class="List_Continue">The mode table is now in place. End the table array with:</div><div id="wwpID0E02B0HA" class="Code_Indent">{ IMX185_TABLE_END, 0x00 }</div><div id="wwpID0E01B0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Create a new element in the list of enumerations and add it to the array of mode tables:</div><div id="wwpID0E0ZB0HA" class="Code_Indent">enum {</div><div id="wwpID0E0YB0HA" class="Code_Indent">    ...</div><div id="wwpID0E0XB0HA" class="Code_Indent">    IMX185_MODE_####X####,</div><div id="wwpID0E0WB0HA" class="Code_Indent">}</div><div id="wwpID0E0VB0HA" class="Code_Indent">&nbsp;</div><div id="wwpID0E0UB0HA" class="Code_Indent">static imx185_reg *mode_table[] = {</div><div id="wwpID0E0TB0HA" class="Code_Indent">    ...</div><div id="wwpID0E0SB0HA" class="Code_Indent">    [IMX185_MODE_####X####] = mode_####x####,</div><div id="wwpID0E0RB0HA" class="Code_Indent">};</div><div id="wwpID0E0QB0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>Add the new mode to the <span class="Code_Char">camera_common_frmfmt</span> array:</div><div id="wwpID0E0PB0HA" class="Code_Indent">static const struct camera_common_frmfmt IMX185_frmfmt[] = {</div><div id="wwpID0E0OB0HA" class="Code_Indent">    ...</div><div id="wwpID0E0NB0HA" class="Code_Indent">    {{####, ####}, 0, IMX185_MODE_####X####},</div><div id="wwpID0E0MB0HA" class="Code_Indent">};</div><div id="wwpID0E0LB0HA" class="Heading_5">Register mode table considerations</div><div id="wwpID0E0KB0HA" class="Body_Text">A mode table can refer to thousands of registers. This increases the delay before the sensor starts streaming by the time required to program all of the registers. In extreme cases, the recipient engine may time out before the sensor outputs the first frame.</div><div id="wwpID0E0JB0HA" class="Body_Text">There are several possible ways to correct this problem:</div><div id="wwpID0E0IB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>Reduce the number of registers referenced in the mode tables. You may be able to get smaller mode tables from the sensor vendor. Most registers are typically set to default values, and do not need to be updated.</div><div id="wwpID0E0HB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>Arrange the registers in small groups with consecutive register addresses. The NVIDIA kernel driver supports <span class="Code_Char">regmap()</span> bulk writes to as many as 16 consecutive registers, which can reduce the number of I2C/SPI transactions. Consult the sensor vendor to be sure you can do this without affecting sensor operations.</div><div id="wwpID0E0GB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>Request a longer delay for the capture engine to prevent timeouts. You can add the device tree property <span class="Code_Char">set_mode_delay_ms</span> to the sensor’s <span class="Code_Char">.dtsi</span> file to extend the wait time for the first frame.</div><H3 id="wwpID0E0FB0HA" class="Heading_3">Camera Sensor Drivers Porting</H3><div id="wwpID0E0EB0HA" class="Body_Text">Jetson Linux Driver Package (L4T) release 31 upgraded the Linux kernel from version 4.4 to 4.9. Sensor drivers developed on L4T Release 28 do not work with the current release. If you have such a driver, you must modify it to work with the release 31 driver interface. This section describes the necessary changes.</div><div id="wwpID0E0DB0HA" class="Body_Text">How to find differences between release 28 and the current release</div><div id="wwpID0E0CB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>Compare the <span class="Code_Char">imx185.c</span> sample driver source file from the release 28 source package to the one from the current release. The sample drivers are at these locations:</div><div id="wwpID0E0BB0HA" class="List_Continue">For release 28.2/28.2.1:</div><div id="wwpID0E0AB0HA" class="Code_Indent">kernel/kernel-4.4/drivers/media/i2c/imx185.c</div><div id="wwpID0E6HA" class="List_Continue">For release 31 and later:</div><div id="wwpID0E5HA" class="Code_Indent">kernel/nvidia/drivers/media/i2c/imx185.c</div><H4 id="wwpID0E4HA" class="Heading_4">Changes for the V4L2 API</H4><div id="wwpID0E3HA" class="Body_Text">The <span class="Code_Char">media_entity_init()</span> function is deprecated in kernel 4.9. NVIDIA provides a new wrapper function, <span class="Code_Char">tegra_media_entity_init()</span>, to adapt to the changes. Modify the following code in the release 28 driver to make it compatible with kernel 4.9.</div><div id="wwpID0E2HA" class="Body_Text">In the driver’s probe() function, replace:</div><div id="wwpID0E1HA" class="Code">    priv-&gt;subdev-&gt;entity.type = MEDIA_ENT_T_V4L2_SUBDEV_SENSOR;</div><div id="wwpID0EZHA" class="Code">    priv-&gt;subdev-&gt;entity.ops = &amp;imx185_media_ops;</div><div id="wwpID0EYHA" class="Code">    err = media_entity_init(&amp;priv-&gt;subdev-&gt;entity, 1, &amp;priv-&gt;pad, 0);</div><div id="wwpID0EXHA" class="Body_Text">With:</div><div id="wwpID0EWHA" class="Code">    priv-&gt;subdev-&gt;entity.ops = &amp;imx185_media_ops;</div><div id="wwpID0EVHA" class="Code">    err = tegra_media_entity_init(&amp;priv-&gt;subdev-&gt;entity, 1,</div><div id="wwpID0EUHA" class="Code">            &amp;priv-&gt;pad, true, true);</div><H4 id="wwpID0ETHA" class="Heading_4">Changes to Device Tree Properties</H4><div id="wwpID0ESHA" class="Body_Text">Release 31 and later support both the I2C and SPI buses, as well as the CPHY and DPHY interfaces. To avoid confusion, make the following changes in the current sensor driver device tree files:</div><div id="wwpID0ERHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>Rename <span class="Code_Char">csi-port</span> to <span class="Code_Char">port-index</span> for VI and CSI endpoints.</div><div id="wwpID0EQHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span style="color: #004831; font-size: 10pt">•	</span></span>Add a new <span class="Code_Char">phy_mode</span> property to each sensor mode. The value can be <span class="Code_Char">DPHY</span> or <span class="Code_Char">CPHY</span>, depending on the sensor type.</div><H4 id="wwpID0EPHA" class="Heading_4">Porting version 1.0 drivers to version 2.0</H4><div id="wwpID0EOHA" class="Body_Text">This section describes changes that you must make to port a version 1.0 driver to version 2.0.</div><div id="wwpID0ENHA" class="Heading_5">Device tree</div><div id="wwpID0EMHA" class="Body_Text">You must add factor, step, and default value properties to the sensor DTSI file to make gain, exposure, and framerate properties work properly.</div><div id="wwpID0ELHA" class="Body_Text">NVIDIA recommends that you set <span class="Code_Char">default_gain</span> to <span class="Code_Char">min_gain_val</span> and <span class="Code_Char">default_framerate</span> to <span class="Code_Char">max_framerate</span>. For <span class="Code_Char">default_exp_time</span>, don’t use <span class="Code_Char">min_exp_time</span> or <span class="Code_Char">max_exp_time</span> because they would make the image too dark or too bright when the sensor is started. Instead, use the exposure time setting from the mode tables.</div><div id="wwpID0EKHA" class="Heading_5">Driver</div><div id="wwpID0EJHA" class="Body_Text">Make the following changes to the driver code. You can also compare source code between version 2.0 and version 1.0 drivers (between <span class="Code_Char">imx185.c</span> and <span class="Code_Char">imx185_v1.c</span>) to see the differences.</div><div id="wwpID0EIHA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Remove all hard coded sensor settings in the sensor driver. The driver should get them from the <span class="Code_Char">.dtsi</span> file.</div><div id="wwpID0EHHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>In <span class="Code_Char">probe()</span>, allocate memory for the new <span class="Code_Char">struct tc_dev</span>. Use it in the new <span class="Code_Char">tegracam_device_register()</span> and <span class="Code_Char">tegracam_subdev_register()</span> functions to set up the sensor context and register the device as a V4L2 subdevice.</div><div id="wwpID0EGHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>If the driver must fulfill any special requirements during sensor probing, create a new <span class="Code_Char">board_setup()</span> function for <span class="Code_Char">probe()</span> to call.</div><div id="wwpID0EFHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>Create a new <span class="Code_Char">ctrl_id_list[]</span>and list all the controls needed by the sensor.</div><div id="wwpID0EEHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>5.	</span></span>Create a <span class="Code_Char">tegracam_ctrl_ops</span> structure that specifies the number of controls and provides a pointer to a handler for each control.</div><div id="wwpID0EDHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>6.	</span></span>Convert all 32‑bit controls to 64‑bit controls.</div><div id="wwpID0ECHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>7.	</span></span>Change the scaling factor used in version 1.0 to a more flexible scaling factor for version 2.0.</div><div id="wwpID0EBHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>8.	</span></span>Be sure to include a group hold control in the version 2.0 driver, as it is now mandatory. If your hardware does not support the group hold feature, create a dummy group hold function.</div></div><div id="page_dates"></div><!-- Related Topics --><!--                --><footer><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><br /></footer></div></div><input type="hidden" id="preserve_unknown_file_links" value="false"></input><noscript><div id="noscript_warning">This site works best with JavaScript enabled</div></noscript><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></body></html>