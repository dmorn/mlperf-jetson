<!DOCTYPE html ><html xml:lang="en" lang="en" data-highlight-require-whitespace="false" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><!-- NVIDIA customization --><title>NVIDIA Jetson Linux Driver Package Software Features : Jetson AGX Xavier PCIe Endpoint Mode | NVIDIA Docs </title><link rel="Prev" href="asoc_driver.19.2.html" title="Previous" /><link rel="Next" href="getting_started.html" title="Next" /><link rel="StyleSheet" href="../css/font-awesome/css/font-awesome.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/xavier_PCIe_endpoint_mode.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/social.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/print.css" type="text/css" media="print" /><noscript><div id="noscript_padding"></div></noscript></head><body id="pUYN8AsQjtvVe8X8QgWHrwQ" class="ww_skin_page_body" style="visibility: hidden;"><input type="hidden" id="page_onload_url" value="../index.html#page/Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html"></input><span id="dropdown_ids" style="display:none;"></span><div id="ww_content_container"><header id="wwconnect_header"><div class="ww_skin_page_toolbar"><div id="dropdown_button_container" class="dropdown_container dropdown_button_container_disabled"><a id="show_hide_all" class="ww_skin ww_behavior_dropdown_toggle ww_skin_dropdown_toggle" title="Page DropDown Toggle" href="#"><i class="fa"></i></a><span class="ww_skin_page_toolbar_divider">&nbsp;</span></div><a class="ww_behavior_print ww_skin ww_skin_print" title="Print" href="#"><i class="fa"></i></a></div><!-- was this helpful button --><!--                         --></header><div id="page_content_container" style="background-attachment: scroll; background-image: url(&quot;watermark.png&quot;); background-position: center center; background-repeat: no-repeat; margin-left: 0pt; margin-right: 10pt; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px"><div id="page_content"><H1 id="wwpID0E0XD0HA" class="Heading_1">Jetson AGX Xavier PCIe Endpoint Mode</H1><div class="WebWorks_MiniTOC"><div class="WebWorks_MiniTOC_Heading">&nbsp;</div><dl class="WebWorks_MiniTOC_List"><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html#wwpID0E0VD0HA">Architecture</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html#wwpID0E0FD0HA">Hardware Requirements</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html#wwpID0E0AD0HA">Assumptions</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html#wwpID0E05C0HA">Flashing the PCIe Endpoint on a Jetson AGX Xavier Series System</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html#wwpID0E0XC0HA">Connecting and Configuring the Systems</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html#wwpID0E0KC0HA">Testing PCIe Endpoint Support</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html#wwpID0ESHA">Bringing Up an Ethernet Interface Over PCIE</a></div></dd></dl></div><div id="wwpID0E0WD0HA" class="Body_Text">This topic describes PCIe endpoint software for NVIDIA<span style="vertical-align: super">®</span> Jetson™ Linux Driver Package (L4T).</div><H2 id="wwpID0E0VD0HA" class="Heading_2">Architecture</H2><div id="wwpID0E0UD0HA" class="Body_Text">L4T contains the following software support for PCIe endpoint mode:</div><div id="wwpID0E0TD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Linux kernel device driver for the PCIe endpoint controller.</div><div id="wwpID0E0SD0HA" class="List_Continue">This driver configures the PCIe controller as an endpoint, and provides an interface for higher level software to select the configuration that is exposed to the PCIe bus.</div><div id="wwpID0E0RD0HA" class="List_Continue">Source code for this driver is available at the following paths in the L4T kernel source package:</div><div id="wwpID0E0QD0HA" class="Code">nvidia/drivers/pci/dwc/pcie-tegra.c</div><div id="wwpID0E0PD0HA" class="Code">kernel-4.9/drivers/pci/dwc/</div><div id="wwpID0E0OD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Trivial example of a Linux kernel PCIe endpoint function driver.</div><div id="wwpID0E0ND0HA" class="List_Continue">This driver provides the configuration of the PCIe endpoint, such as BAR count and size, IRQ count, etc. It also implements any runtime functionality of the endpoint.</div><div id="wwpID0E0MD0HA" class="List_Continue">This driver is a minimal example, useful for demonstration purposes only. The driver does not interact with the host or with any other part of the endpoint software at run time. It simply exposes some endpoint RAM to the PCIe bus. The customer is expected to implement their own PCIe endpoint function driver according to the needs of their application.</div><div id="wwpID0E0LD0HA" class="List_Continue">Source code for this driver is available at the following path in the L4T kernel source package:</div><div id="wwpID0E0KD0HA" class="Code">nvidia/drivers/pci/endpoint/functions/pci-epf-nv-test.c</div><div id="wwpID0E0JD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Linux kernel PCIe endpoint subsystem.</div><div id="wwpID0E0ID0HA" class="List_Continue">The PCIe endpoint subsystem provides common PCIe endpoint support code. It binds together endpoint controller drivers and endpoint function drivers.</div><div id="wwpID0E0HD0HA" class="List_Continue">Source code for this subsystem is available at the following path in the L4T kernel source package:</div><div id="wwpID0E0GD0HA" class="Code">kernel/kernel-4.9/drivers/pci/endpoint/</div><H2 id="wwpID0E0FD0HA" class="Heading_2">Hardware Requirements</H2><div id="wwpID0E0ED0HA" class="Body_Text">You need the following hardware to use PCIe endpoint support:</div><div id="wwpID0E0DD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>A Jetson AGX Xavier series system running L4T, to act as the PCIe endpoint.</div><div id="wwpID0E0CD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Another computer system, to act as the PCIe root port. This application note assumes that you will use a second Jetson AGX Xavier system running L4T. However, any standard x86-64 PC running Linux will act almost identically.</div><div id="wwpID0E0BD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Cables to connect the two systems. See the NVIDIA application note <span class="Emphasis">NVIDIA Jetson AGX Xavier PCIe Endpoint Design Guidelines</span> (DA‑09357) for details.</div><H2 id="wwpID0E0AD0HA" class="Heading_2">Assumptions</H2><div id="wwpID0E06C0HA" class="Body_Text">All commands described in this application note must be run as root. Some commands use shell I/O redirection, and will not operate correctly if run using <span class="Code_Char">sudo</span>.</div><H2 id="wwpID0E05C0HA" class="Heading_2">Flashing the PCIe Endpoint on a Jetson AGX Xavier Series System</H2><div id="wwpID0E04C0HA" class="Body_Text">A Jetson system must be flashed in a specific way to enable PCIe endpoint mode. Use the following steps to flash the endpoint system:</div><div id="wwpID0E03C0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>In the extracted L4T release directory, <span class="Code_Char">edit p2972-0000.conf.common</span>. Set bit&nbsp;12 of the ODMDATA value, i.e. change it from <span class="Code_Char">0x09190000</span> to <span class="Code_Char">0x09191000</span>.</div><div id="wwpID0E02C0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Run the following command to re-flash the system:</div><div id="wwpID0E01C0HA" class="Code">sudo ./flash.sh jetson-xavier mmcblk0p1</div><div id="wwpID0E0ZC0HA" class="List_Continue">Note that this completely erases any data previously stored on the Jetson system.</div><div id="wwpID0E0YC0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Edit <span class="Code_Char">p2972-0000.conf.common</span> again and restore the <span class="Code_Char">ODMDATA</span> property’s original value. This ensures that any systems flashed in the future operate in PCIe root port mode.</div><H2 id="wwpID0E0XC0HA" class="Heading_2">Connecting and Configuring the Systems</H2><div id="wwpID0E0WC0HA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Connect the systems using the appropriate PCIe cable.</div><div id="wwpID0E0VC0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Boot the endpoint Jetson system.</div><div id="wwpID0E0UC0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Run the following commands to configure and enable PCIe endpoint mode:</div><div id="wwpID0E0TC0HA" class="Code">cd /sys/kernel/config/pci_ep/</div><div id="wwpID0E0SC0HA" class="Code">mkdir functions/pci_epf_nv_test/func1</div><div id="wwpID0E0RC0HA" class="Code">echo 0x10de &gt; functions/pci_epf_nv_test/func1/vendorid</div><div id="wwpID0E0QC0HA" class="Code">echo 0x0001 &gt; functions/pci_epf_nv_test/func1/deviceid</div><div id="wwpID0E0PC0HA" class="Code">ln -s functions/pci_epf_nv_test/func1 controllers/141a0000.pcie_ep/</div><div id="wwpID0E0OC0HA" class="Code">echo 1 &gt; controllers/141a0000.pcie_ep/start</div><div id="wwpID0E0NC0HA" class="List_Continue">For additional details, read the following file in the L4T kernel source package:</div><div id="wwpID0E0MC0HA" class="Code">kernel-4.9/Documentation/PCI/endpoint/pci-endpoint-cfs.txt</div><div id="wwpID0E0LC0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>Boot the root port system. You must execute this step after step&nbsp;<a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/xavier_PCIe_endpoint_mode.html#wwpID0E0UC0HA" title="Jetson AGX Xavier PCIe Endpoint Mode">3</a> above.</div><H2 id="wwpID0E0KC0HA" class="Heading_2">Testing PCIe Endpoint Support</H2><div id="wwpID0E0JC0HA" class="Body_Text">The example PCIe endpoint function driver exposes a page of RAM to the root port system. This allows both the endpoint and root port systems access to a shared page of RAM. This section demonstrates a simple method for transferring data between the two systems through the shared RAM.</div><div id="wwpID0E0IC0HA" class="Body_Text">On both the root port and endpoint systems, run this command to install required utilities:</div><div id="wwpID0E0HC0HA" class="Code">apt install busybox pciutils</div><div id="wwpID0E0GC0HA" class="Body_Text">On the endpoint system, determine the physical address of the RAM that is accessed via the endpoint's BAR:</div><div id="wwpID0E0FC0HA" class="Code">dmesg|grep pci_epf_nv_test</div><div id="wwpID0E0EC0HA" class="Body_Text">This command will print messages similar to the following:</div><div id="wwpID0E0DC0HA" class="Code">[   38.338101] pci_epf_nv_test pci_epf_nv_test.0: BAR0 RAM phys: 0x4307b8000</div><div id="wwpID0E0CC0HA" class="Code">[   38.338113] pci_epf_nv_test pci_epf_nv_test.0: BAR0 RAM IOVA: 0xffff0000</div><div id="wwpID0E0BC0HA" class="Code">[   38.338138] pci_epf_nv_test pci_epf_nv_test.0: BAR0 RAM virt: 0xffffff800b3dc000</div><div id="wwpID0E0AC0HA" class="Body_Text">Make a note of the "BAR0 RAM phys" address.</div><div id="wwpID0E06B0HA" class="Body_Text">On the endpoint system, you may access the shared RAM using BusyBox. To read the RAM, enter this command:</div><div id="wwpID0E05B0HA" class="Code">busybox devmem 0x4307b8000</div><div id="wwpID0E04B0HA" class="Body_Text">To write the RAM, enter this command:</div><div id="wwpID0E03B0HA" class="Code">busybox devmem 0x4307b8000 32 0xfa950000</div><div id="wwpID0E02B0HA" class="Body_Text">To allow the PCIe endpoint to respond to PCIe memory accesses on the root port system, enter this command:</div><div id="wwpID0E01B0HA" class="Code">setpci -s 0005:01:00.0 COMMAND=0x02</div><div id="wwpID0E0ZB0HA" class="Body_Text">Note that this command is required only if no Linux kernel device driver binds to the PCIe device and enables the device.</div><div id="wwpID0E0YB0HA" class="Body_Text">To determine the PCIe address allocated to the endpoint's BAR on the root port system, enter this command:</div><div id="wwpID0E0XB0HA" class="Code">lspci -v</div><div id="wwpID0E0WB0HA" class="Body_Text">This command prints messages similar to the following:</div><div id="wwpID0E0VB0HA" class="Code">0005:01:00.0 RAM memory: NVIDIA Corporation Device 0001</div><div id="wwpID0E0UB0HA" class="Code">    Flags: fast devsel, IRQ 255</div><div id="wwpID0E0TB0HA" class="Code">    Memory at 3a300000 (32-bit, non-prefetchable) [disabled] [size=64K]</div><div id="wwpID0E0SB0HA" class="Code">    Memory at 1c00000000 (64-bit, prefetchable) [disabled] [size=128K]</div><div id="wwpID0E0RB0HA" class="Code">    Memory at 3a200000 (64-bit, non-prefetchable) [disabled] [size=1M]</div><div id="wwpID0E0QB0HA" class="Code">    Capabilities: [40] Power Management version 3</div><div id="wwpID0E0PB0HA" class="Code">    Capabilities: [50] MSI: Enable- Count=1/1 Maskable+ 64bit-</div><div id="wwpID0E0OB0HA" class="Code">    Capabilities: [70] Express Endpoint, MSI 00</div><div id="wwpID0E0NB0HA" class="Code">    Capabilities: [b0] MSI-X: Enable- Count=8 Masked-</div><div id="wwpID0E0MB0HA" class="Code">    Capabilities: [100] Advanced Error Reporting</div><div id="wwpID0E0LB0HA" class="Code">    Capabilities: [148] #19</div><div id="wwpID0E0KB0HA" class="Code">    Capabilities: [168] #26</div><div id="wwpID0E0JB0HA" class="Code">    Capabilities: [190] #27</div><div id="wwpID0E0IB0HA" class="Code">    Capabilities: [1b8] Latency Tolerance Reporting</div><div id="wwpID0E0HB0HA" class="Code">    Capabilities: [1c0] L1 PM Substates</div><div id="wwpID0E0GB0HA" class="Code">    Capabilities: [1d0] Vendor Specific Information: ID=0002 Rev=4 Len=100 &lt;?&gt;</div><div id="wwpID0E0FB0HA" class="Code">    Capabilities: [2d0] Vendor Specific Information: ID=0001 Rev=1 Len=038 &lt;?&gt;</div><div id="wwpID0E0EB0HA" class="Code">    Capabilities: [308] #25</div><div id="wwpID0E0DB0HA" class="Code">    Capabilities: [314] Precision Time Measurement</div><div id="wwpID0E0CB0HA" class="Code">    Capabilities: [320] Vendor Specific Information: ID=0003 Rev=1 Len=054 &lt;?&gt;</div><div id="wwpID0E0BB0HA" class="Body_Text">Make a note of the first “Memory at” address (the <span class="Code_Char">BAR0</span> address). The CPU may access this address directly on the root port system. Any such access modifies RAM on the endpoint system. To read the RAM, enter this command:</div><div id="wwpID0E0AB0HA" class="Code">busybox devmem 0x3a300000</div><div id="wwpID0E6HA" class="Body_Text">To write the RAM, enter this command:</div><div id="wwpID0E5HA" class="Code">busybox devmem 0x3a300000 32 0xfa950000</div><div id="wwpID0E4HA" class="Body_Text">To test bidirectional data transfer, enter this sequence of commands:</div><div id="wwpID0E3HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>On the endpoint system:</div><div id="wwpID0E2HA" class="Code">busybox devmem 0x4307b8000 32 0x98765432</div><div id="wwpID0E1HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>On the root port system:</div><div id="wwpID0EZHA" class="Code">busybox devmem 0x3a300000</div><div id="wwpID0EYHA" class="List_Continue">Observe that the memory location contains the value <span class="Code_Char">0x98765432</span>, which was written by the endpoint system.</div><div id="wwpID0EXHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Root port system:</div><div id="wwpID0EWHA" class="Code">busybox devmem 0x3a300000 32 0x12345678</div><div id="wwpID0EVHA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Endpoint system:</div><div id="wwpID0EUHA" class="Code">busybox devmem 0x4307b8000</div><div id="wwpID0ETHA" class="List_Continue">Observe that the memory location contains the value <span class="Code_Char">0x12345678</span>, which was written by the root port system.</div><H2 id="wwpID0ESHA" class="Heading_2">Bringing Up an Ethernet Interface Over PCIE</H2><div id="wwpID0ERHA" class="Body_Text">Use the following procedure to bring up an Ethernet interface over PCIE.</div><div id="wwpID0EQHA" class="Heading_5">To bring up an Ethernet interface over PCIE</div><div id="wwpID0EPHA" class="List_Number" style="text-indent: -18pt"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Connect the systems using the appropriate PCIe cable.</div><div id="wwpID0EOHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Boot the endpoint Jetson system.</div><div id="wwpID0ENHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Enter the following commands to configure and enable PCIe endpoint mode:</div><div id="wwpID0EMHA" class="Code">cd /sys/kernel/config/pci_ep/</div><div id="wwpID0ELHA" class="Code">mkdir functions/pci_epf_tvnet/func1</div><div id="wwpID0EKHA" class="Code">echo 16 &gt; functions/pci_epf_tvnet/func1/msi_interrupts</div><div id="wwpID0EJHA" class="Code">ln -s functions/pci_epf_tvnet/func1 controllers/141a0000.pcie_ep/</div><div id="wwpID0EIHA" class="Code">echo 1 &gt; controllers/141a0000.pcie_ep/start</div><div id="wwpID0EHHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>4.	</span></span>Boot the root port system.</div><div id="wwpID0EGHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>5.	</span></span>Verify that the PCIe link is up by entering the <span class="Code_Char">lspci</span> command in root port system. The console output should include “PCIe device with vendor id: 0x10de and device id: 0x2296.”</div><div id="wwpID0EFHA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>6.	</span></span>Bring up both interfaces to establish an Ethernet link between the systems. Then assign them dynamic or static IP addresses.</div><div id="wwpID0EEHA" class="List_Continue">For example, enter the following commands, in the order shown, to bring up the Ethernet interfaces and assign static IP addresses:</div><div id="wwpID0EDHA" class="List_Continue_2">On the endpoint system:	<span class="Code_Char">ifconfig eth1 up</span><br />On the root port system:	<span class="Code_Char">ifconfig eth1 up</span><br />On the endpoint system:	<span class="Code_Char">ifconfig eth1 192.168.2.1</span><br />On the root port system:	<span class="Code_Char">ifconfig eth1 192.168.2.2</span></div><div id="wwpID0ECHA" class="List_Continue">Ethernet interface <span class="Code_Char">eth1</span> is created in both systems.</div><div id="wwpID0EBHA" class="Body_Text">&nbsp;</div></div><div id="page_dates"></div><!-- Related Topics --><!--                --><footer><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><br /></footer></div></div><input type="hidden" id="preserve_unknown_file_links" value="false"></input><noscript><div id="noscript_warning">This site works best with JavaScript enabled</div></noscript><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></body></html>